<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire OS - Stable Restore v16.2</title>
    
    <script>
        (function(){
            const originalWarn = console.warn;
            console.warn = function(message, ...rest) {
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return;
                }
                originalWarn.call(console, message, ...rest);
            };
        })();
    </script>
    <!-- Tailwind CSS (CDN Build for SPA) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif']
                    }
                }
            }
        };
    </script>

    <style>
        :root {
            --color-bg: #f4f6fb;
            --color-surface: #ffffff;
            --color-surface-alt: #f8fafc;
            --color-sidebar: #0f172a;
            --color-border: #e2e8f0;
            --color-text: #111827;
            --color-text-light: #6b7280;
            --color-primary: #4f46e5;
            --color-primary-dark: #4338ca;
            --color-amber: #f59e0b;
            --color-emerald: #10b981;
            --color-danger: #ef4444;
            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
            --shadow-hover: 0 20px 45px rgba(15, 23, 42, 0.12);
            --radius-lg: 20px;
        }
        html.dark {
            --color-bg: #050914;
            --color-surface: #111827;
            --color-surface-alt: #1f2937;
            --color-sidebar: #030712;
            --color-border: #1f2937;
            --color-text: #f1f5f9;
            --color-text-light: #94a3b8;
            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.4);
            --shadow-hover: 0 25px 50px rgba(15, 23, 42, 0.6);
        }

        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            display: flex;
            min-height: 100vh;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        a { color: inherit; }
        img { max-width: 100%; display: block; }
        button { font-family: inherit; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
        html.dark ::-webkit-scrollbar-thumb { background: #1f2937; }

        /* Layout */
        body.app-shell { display: flex; }
        .sidebar {
            width: 270px;
            background: var(--color-sidebar);
            color: #e2e8f0;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            gap: 2rem;
        }
        @media (max-width: 1024px) {
            .sidebar { display: none; }
        }
        .sidebar .brand { display: flex; gap: 0.75rem; align-items: center; }
        .sidebar .brand-badge {
            width: 48px; height: 48px; border-radius: 16px;
            background: linear-gradient(135deg, #6366f1, #ec4899);
            display: grid; place-items: center; font-size: 1.4rem;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.5);
        }
        .sidebar h1 { margin: 0; font-size: 1.25rem; }
        .sidebar p { margin: 0; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.2em; color: #94a3b8; }

        .nav-menu { flex: 1; display: flex; flex-direction: column; gap: 0.35rem; }
        .nav-item {
            border: 1px solid transparent;
            border-radius: 14px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #94a3b8;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .nav-item:hover { background: rgba(148, 163, 184, 0.12); color: #f8fafc; }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(147,51,234,0.2));
            color: #fff;
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
        }

        .sidebar .profile {
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            padding-top: 1.5rem;
        }
        .profile-card { display: flex; gap: 0.75rem; align-items: center; }
        .profile-card .avatar {
            width: 44px; height: 44px; border-radius: 14px;
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            display: grid;
            place-items: center;
            font-weight: 700;
        }
        .xp-track { margin-top: 0.75rem; }
        .xp-track-bar {
            width: 100%; height: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.15);
            overflow: hidden;
        }
        .xp-track-bar span {
            display: block;
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, #f472b6, #a855f7, #6366f1);
            transition: width 0.4s ease;
        }
        .xp-track footer { margin-top: 0.35rem; display: flex; justify-content: space-between; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: #94a3b8; }

        .main-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--color-bg); }
        .top-bar {
            height: 70px;
            padding: 0 2rem;
            border-bottom: 1px solid var(--color-border);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(14px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky; top: 0; z-index: 10;
        }
        html.dark .top-bar { background: rgba(17, 24, 39, 0.85); }
        .top-actions { display: flex; gap: 0.5rem; }
        .icon-btn {
            width: 40px; height: 40px;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-light);
            display: grid; place-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .icon-btn:hover { color: var(--color-primary); border-color: rgba(79, 70, 229, 0.4); box-shadow: 0 6px 18px rgba(79, 70, 229, 0.15); }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2.5rem clamp(1.5rem, 4vw, 3.5rem);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.85), var(--color-bg));
        }
        .page-transition { animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            box-shadow: var(--shadow-soft);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        html.dark .card { background: var(--color-surface); }

        .hero-grid {
            display: grid;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .hero-grid { grid-template-columns: 2fr 1fr; }
        }
        .hero-card { display: flex; flex-direction: column; gap: 1rem; }
        .hero-card h2 { margin: 0; font-size: 2rem; }
        .hero-card canvas { height: 150px !important; }

        .projection-card {
            color: #fff;
            background: linear-gradient(135deg, #312e81, #6d28d9);
            border: none;
            position: relative;
            overflow: hidden;
        }
        .projection-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.25), transparent 55%);
            opacity: 0.7;
        }
        .projection-card > * { position: relative; z-index: 1; }

        .dashboard-kpis {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .kpi-card { padding: 1.25rem; border-left: 5px solid var(--color-primary); }
        .kpi-card p { margin: 0; }
        .kpi-card span { font-size: 1.3rem; font-weight: 800; }

        .xp-card { display: flex; gap: 1.5rem; align-items: center; margin-top: 1rem; }
        .xp-bar { flex: 1; height: 10px; border-radius: 999px; background: var(--color-border); overflow: hidden; }
        .xp-bar span { display: block; height: 100%; background: linear-gradient(90deg, #f472b6, #a855f7, #6366f1); border-radius: inherit; }

        .dashboard-bottom { margin-top: 2rem; display: grid; gap: 1.5rem; }
        @media (min-width: 1100px) { .dashboard-bottom { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .radar-card, .quick-card, .trophy-card { min-height: 360px; display: flex; flex-direction: column; }
        .radar-card .card-header,
        .quick-card .card-header,
        .trophy-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 1rem; }
        .quick-actions-grid button {
            border: none;
            border-radius: 16px;
            padding: 1rem;
            font-weight: 700;
            background: rgba(79, 70, 229, 0.08);
            color: var(--color-primary);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .quick-actions-grid button:nth-child(2) { background: rgba(245, 158, 11, 0.15); color: #c2410c; }
        .quick-actions-grid button:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(15,23,42,0.1); }

        .finance-grid { display: grid; gap: 1.5rem; margin-top: 2rem; }
        @media (min-width: 1100px) { .finance-grid { grid-template-columns: 1fr 2fr; } }
        .finance-grid .cards-stack { display: flex; flex-direction: column; gap: 1.25rem; }
        .pots-card { background: linear-gradient(135deg, rgba(79,70,229,0.08), rgba(16,185,129,0.08)); }

        .tabs-layout { margin: 1.5rem 0; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .tab-btn {
            border: 1px solid var(--color-border);
            border-radius: 999px;
            padding: 0.35rem 1.25rem;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-light);
            background: var(--color-surface);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-btn.active { background: var(--color-primary); color: #fff; border-color: transparent; box-shadow: 0 10px 20px rgba(79,70,229,0.4); }

        /* Buttons & Inputs */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            padding: 0.9rem 1.4rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-primary { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: #fff; box-shadow: 0 12px 30px rgba(79,70,229,0.35); }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-secondary { background: rgba(79,70,229,0.08); color: var(--color-primary); border: 1px solid rgba(79,70,229,0.2); }
        .btn-text { background: transparent; color: var(--color-text-light); padding: 0.5rem 0.75rem; border-radius: 10px; }
        .btn-text:hover { color: var(--color-primary); background: rgba(79, 70, 229, 0.1); }
        input, select, textarea {
            border-radius: 12px;
            border: 1px solid var(--color-border);
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            background: var(--color-surface-alt);
            color: var(--color-text);
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); }

        /* Modals */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.75);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .modal-panel {
            width: 100%;
            max-width: 420px;
            background: var(--color-surface);
            border-radius: 24px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-hover);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .modal-panel h3 { margin: 0; font-size: 1.2rem; }

        /* Utility */
        .hidden { display: none !important; }
        .trophy-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    </style>
</head>
<body class="app-shell">

    <!-- MODALS -->
    <div id="input-modal" class="modal-backdrop hidden">
        <div class="modal-panel">
            <h3 id="modal-title">Novo Item</h3>
            <input type="text" id="modal-input" placeholder="Digite aqui...">
            <div class="modal-actions" style="display:flex;gap:0.75rem;justify-content:flex-end;">
                <button onclick="closeInputModal()" class="btn btn-text">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="calc-modal" class="modal-backdrop hidden">
        <div class="modal-panel" style="max-width:520px; max-height:80vh;">
            <div class="card-header" style="border-bottom:1px solid var(--color-border); padding-bottom:1rem; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; font-size:1.1rem; display:flex; gap:0.5rem; align-items:center;"><i class="ph-bold ph-calculator" style="color:var(--color-primary);"></i>Detalhes de Sobreviv√™ncia</h3>
                <button onclick="toggleCalc(false)" class="icon-btn" style="width:36px;height:36px;"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="calc-items-list" style="flex:1; overflow-y:auto; margin:1rem 0; display:flex; flex-direction:column; gap:0.75rem;"></div>
            <button onclick="addSurvivalItem()" class="btn btn-secondary" style="width:100%;">+ Adicionar Gasto</button>
            <div style="border-top:1px solid var(--color-border); padding-top:1rem; margin-top:1rem; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700; color:var(--color-text-light);">Total Mensal:</span>
                <span id="calc-total" style="font-size:1.4rem; font-weight:800; color:var(--color-primary);">R$ 0</span>
            </div>
            <button onclick="applyCalc()" class="btn btn-primary" style="width:100%;">Salvar e Fechar</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-badge">
                <i class="ph-fill ph-planet"></i>
            </div>
            <div>
                <h1>Empire OS</h1>
                <p>Stable v16.2</p>
            </div>
        </div>

        <nav class="nav-menu">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i class="ph-duotone ph-squares-four text-xl"></i> Vis√£o Geral
            </button>
            <button onclick="switchTab('finance')" id="nav-finance" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i class="ph-duotone ph-chart-pie-slice text-xl"></i> Financeiro
            </button>
            <button onclick="switchTab('projects')" id="nav-projects" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i class="ph-duotone ph-target text-xl"></i> Metas & Sonhos
            </button>
            <button onclick="switchTab('roadmap')" id="nav-roadmap" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-slate-500 dark:text-slate-400 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                <i class="ph-duotone ph-map-trifold text-xl"></i> Jornada
            </button>
        </nav>

        <div class="profile">
            <div class="profile-card">
                <div class="avatar">M&L</div>
                <div>
                    <strong>Marcelino & Luiza</strong>
                    <p id="user-rank">N√≠vel 1</p>
                </div>
            </div>
            <div class="xp-track">
                <div class="xp-track-bar"><span id="xp-bar-side" style="width:0%"></span></div>
                <footer><span>XP</span><span id="xp-val-side">0/1000</span></footer>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-area">
        
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-xl font-bold text-slate-800 dark:text-white">Vis√£o Geral</h2>
                <span id="last-saved" class="text-xs text-emerald-500 font-bold flex items-center gap-1 opacity-0 transition-opacity bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded-full"><i class="ph-bold ph-check"></i> Salvo</span>
            </div>
            <div class="top-actions no-print">
                <button onclick="downloadData()" class="icon-btn" title="Backup"><i class="ph-bold ph-download-simple"></i></button>
                <label class="icon-btn" title="Restaurar" style="cursor:pointer;">
                    <i class="ph-bold ph-upload-simple"></i>
                    <input type="file" class="hidden" accept=".json" onchange="uploadData(this)">
                </label>
                <button onclick="resetAllData()" class="icon-btn" title="Resetar"><i class="ph-bold ph-trash"></i></button>
                <button onclick="toggleTheme()" class="icon-btn" title="Tema"><i class="ph-bold ph-moon"></i></button>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="content-area" id="content-area">
            
            <!-- 1. DASHBOARD -->
            <div id="view-dashboard" class="page-transition space-y-8 max-w-7xl mx-auto">
                
                <!-- Hero HUD -->
                <div class="hero-grid">
                    <!-- Main Stat -->
                    <div class="card hero-card hero-card--main">
                         <div class="flex justify-between items-start z-10">
                             <div>
                                 <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Fluxo de Caixa Mensal</p>
                                 <h2 class="text-3xl font-black text-slate-800 dark:text-white" id="dash-income">R$ 0,00</h2>
                             </div>
                             <div class="bg-indigo-50 dark:bg-slate-900 px-3 py-1 rounded-lg border border-indigo-100 dark:border-slate-700">
                                 <span class="text-xs font-bold text-indigo-600">Renda Total</span>
                             </div>
                         </div>
                         <div class="h-32 w-full mt-4 z-10"><canvas id="cashflowChart"></canvas></div>
                    </div>

                    <!-- Projection -->
                    <div class="card projection-card">
                        <div class="absolute right-0 top-0 h-full w-1/2 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <div class="z-10">
                            <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest mb-1">Patrim√¥nio em 12 Meses</p>
                            <h3 class="text-2xl font-bold text-white mb-1" id="dash-projection">R$ 0</h3>
                            <p class="text-[10px] text-indigo-200">Baseado na sobra atual</p>
                        </div>
                        <div class="h-24 w-full relative z-10 mt-2"><canvas id="projectionChart"></canvas></div>
                    </div>
                </div>

                <!-- KPI STRIP -->
                <div class="dashboard-kpis">
                    <div class="card kpi-card" style="border-left-color: var(--color-emerald);">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Patrim√¥nio L√≠quido</p>
                        <p id="kpi-networth" class="text-xl font-black text-slate-800 dark:text-white">R$ 0</p>
                    </div>
                    <div class="card kpi-card" style="border-left-color: var(--color-amber);">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Sobra Mensal</p>
                        <p id="kpi-pot" class="text-xl font-black text-slate-800 dark:text-white">R$ 0</p>
                    </div>
                    <div class="card kpi-card" style="border-left-color: var(--color-danger);">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Dias p/ Liberdade</p>
                        <p id="kpi-freedom" class="text-xl font-black text-slate-800 dark:text-white">--</p>
                    </div>
                    <!-- Score -->
                    <div class="card kpi-card group" style="border-left-color: var(--color-primary); position:relative;">
                        <div class="flex justify-between items-center">
                             <p class="text-[10px] font-bold text-slate-400 uppercase">Empire Score</p>
                             <i class="ph-fill ph-info text-slate-300 text-xs cursor-help"></i>
                        </div>
                        <p id="kpi-score" class="text-xl font-black text-slate-800 dark:text-white">0</p>
                        <!-- Tooltip -->
                        <div class="absolute bottom-full right-0 mb-2 w-48 bg-slate-900 text-white text-[10px] p-3 rounded-xl shadow-lg opacity-0 invisible group-hover:visible transition z-50 pointer-events-none">
                            <p class="font-bold text-indigo-300 border-b border-slate-700 pb-1 mb-2">Pontua√ß√£o</p>
                            <div class="flex justify-between mb-1"><span>Finan√ßas</span><span id="sb-finance">0</span></div>
                            <div class="flex justify-between mb-1"><span>Tarefas</span><span id="sb-tasks">0</span></div>
                            <div class="flex justify-between"><span>D√≠vidas</span><span id="sb-debt">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- XP Tracker -->
                <div class="card xp-card">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Progress√£o</p>
                        <p class="text-lg font-black text-slate-800 dark:text-white">N√≠vel <span id="xp-level-display">1</span></p>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-1">
                            <span>XP Atual</span>
                            <span id="xp-val" class="text-slate-600 dark:text-slate-300">0/1000</span>
                        </div>
                        <div class="xp-bar"><span id="xp-bar" style="width:0%"></span></div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="dashboard-bottom">
                    <!-- 1. Radar & Feed -->
                    <div class="card radar-card">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2"><i class="ph-bold ph-radar text-blue-500"></i> Radar & Feed</h3>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 space-y-4">
                            <div id="dashboard-goals-list" class="space-y-3 pb-4 border-b border-slate-100 dark:border-slate-700"></div>
                            <div id="dash-feed" class="space-y-3"></div>
                        </div>
                    </div>

                    <!-- 2. Actions & Vault -->
                    <div class="card quick-card">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm mb-4 flex items-center gap-2"><i class="ph-bold ph-lightning text-amber-500"></i> A√ß√µes R√°pidas</h3>
                        <div class="quick-actions-grid">
                            <button onclick="quickDeposit()" class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800 flex flex-col items-center justify-center hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition text-emerald-700 dark:text-emerald-400">
                                <i class="ph-bold ph-piggy-bank text-2xl mb-1"></i>
                                <span class="text-xs font-bold">Guardar</span>
                            </button>
                            <button onclick="incrementStreak()" class="p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-xl border border-indigo-100 dark:border-indigo-800 flex flex-col items-center justify-center hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition text-indigo-700 dark:text-indigo-400">
                                <i class="ph-bold ph-fire text-2xl mb-1"></i>
                                <span class="text-xs font-bold">Foco Di√°rio</span>
                            </button>
                        </div>
                        <div class="mt-auto bg-slate-50 dark:bg-slate-900 p-4 rounded-xl border border-slate-100 dark:border-slate-700">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-1">Total no Cofre</p>
                            <p class="text-2xl font-black text-slate-800 dark:text-white" id="dash-vault-total">R$ 0</p>
                        </div>
                    </div>

                    <!-- 3. Trophy Room -->
                    <div class="card trophy-card">
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm flex items-center gap-2"><i class="ph-fill ph-trophy text-amber-500"></i> Conquistas</h3>
                            <span class="text-xs text-slate-400 bg-slate-100 dark:bg-slate-900 px-2 py-1 rounded-full" id="dash-badge-count">0/8</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3 flex-grow content-start overflow-y-auto pr-1" id="badges-container"></div>
                    </div>
                </div>
            </div>

            <!-- 2. FINANCE (Full CRUD) -->
            <div id="view-finance" class="hidden page-transition space-y-6 max-w-7xl mx-auto">
                <div class="finance-grid">
                    <!-- Income -->
                    <div class="card finance-card cards-stack">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><i class="ph-bold ph-users-three text-indigo-500"></i> Fontes de Renda</h3>
                            <button onclick="addIncomeSource()" class="text-xs text-indigo-500 hover:text-indigo-700 font-bold">+ Adicionar</button>
                        </div>
                        <div id="income-list" class="space-y-2 flex-grow overflow-y-auto max-h-[300px] mb-4"></div>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700">
                            <div class="flex justify-between items-end">
                                <span class="text-xs font-bold text-slate-400 uppercase">Total L√≠quido</span>
                                <span id="total-income-display" class="text-xl font-bold text-slate-800 dark:text-white">R$ 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pots Simulator -->
                    <div class="card pots-card">
                        <h3 class="font-bold text-slate-700 dark:text-slate-200 mb-6 flex items-center gap-2"><i class="ph-bold ph-sliders text-indigo-500"></i> Distribui√ß√£o dos Potes</h3>
                        
                        <!-- Pote 1 -->
                        <div class="mb-6 border border-slate-200 rounded-xl p-4 bg-slate-50/50 dark:bg-slate-800/50 dark:border-slate-700">
                            <div class="flex justify-between items-center mb-4">
                                <span class="flex items-center gap-2 font-bold text-slate-600 dark:text-slate-300"><i class="ph-fill ph-house text-slate-400"></i> Pote 1: Sobreviv√™ncia (CRUD)</span>
                                <button onclick="addSurvivalItem()" class="text-xs bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-2 py-1 rounded hover:text-indigo-500 shadow-sm">+ Item</button>
                            </div>
                            <div id="survival-list" class="space-y-2 max-h-40 overflow-y-auto pr-2 mb-2"></div>
                            <div class="flex justify-between items-center border-t border-slate-200 dark:border-slate-700 pt-2">
                                <span class="text-xs text-slate-400 uppercase font-bold">Total Fixo</span>
                                <span id="survival-display" class="font-bold text-slate-700 dark:text-slate-200">R$ 0</span>
                            </div>
                        </div>

                        <!-- Pote 3 -->
                        <div class="mb-6">
                            <div class="flex justify-between text-sm font-bold text-amber-600 mb-2">
                                <span class="flex items-center gap-2"><i class="ph-fill ph-smiley text-amber-400"></i> Pote 3: Sanidade</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <input type="range" id="sanity-slider" min="0" max="5000" step="50" class="flex-grow h-2 bg-amber-200 rounded-lg appearance-none cursor-pointer accent-amber-500" oninput="syncSlider('sanity')">
                                <span id="sanity-display" class="w-24 text-right font-bold text-amber-600">R$ 0</span>
                            </div>
                        </div>

                        <!-- Result -->
                        <div class="p-6 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-900/30 flex justify-between items-center relative overflow-hidden">
                            <div class="relative z-10">
                                <p class="text-xs font-bold text-emerald-600 uppercase tracking-wide">Pote do Futuro (Sobra)</p>
                                <p class="text-[10px] text-emerald-500">Dispon√≠vel para Metas e D√≠vidas</p>
                            </div>
                            <p id="future-pot-display" class="text-4xl font-black text-emerald-500 relative z-10">R$ 0</p>
                        </div>
                    </div>

                    <!-- Vault History -->
                    <div class="lg:col-span-12 card p-6 dark:bg-slate-800">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><i class="ph-fill ph-safe text-blue-500"></i> Extrato do Cofre Real</h3>
                            <div class="flex gap-2">
                                <input type="number" id="deposit-input" placeholder="Valor R$" class="w-32 text-sm border border-slate-200 rounded px-3 py-1.5 bg-slate-50 dark:bg-slate-900 dark:border-slate-700 dark:text-white">
                                <button onclick="addDeposit()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow-md transition">Depositar</button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <div class="w-full md:w-1/3">
                                <p class="text-xs text-slate-400 uppercase font-bold">Total Acumulado</p>
                                <p id="vault-total" class="text-4xl font-black text-slate-800 dark:text-white mb-2">R$ 0</p>
                                <div class="w-full bg-slate-100 dark:bg-slate-700 h-2 rounded-full overflow-hidden">
                                    <div id="vault-progress" class="h-full bg-blue-500 transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">Meta Global das Metas: <span id="vault-goal">R$ 0</span></p>
                            </div>
                            <div class="w-full md:w-2/3 border-l border-slate-100 dark:border-slate-700 pl-0 md:pl-8">
                                <p class="text-xs font-bold text-slate-400 uppercase mb-3">Hist√≥rico Recente</p>
                                <div id="vault-history" class="space-y-2 max-h-32 overflow-y-auto pr-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. PROJECTS -->
            <div id="view-projects" class="hidden page-transition space-y-6 max-w-7xl mx-auto h-[calc(100vh-140px)] flex flex-col">
                <div class="flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar border-b border-slate-200 dark:border-slate-700 shrink-0">
                    <div id="goal-tabs-container" class="flex gap-2"></div>
                    <button onclick="promptNewGoal()" class="flex items-center gap-1 px-3 py-2 text-xs font-bold text-slate-400 hover:text-indigo-500 hover:bg-indigo-50 rounded-t-lg transition whitespace-nowrap"><i class="ph-bold ph-plus"></i> Nova Meta</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow overflow-hidden">
                    <div class="lg:col-span-8 card p-0 flex flex-col overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex flex-wrap gap-4 justify-between items-center shrink-0">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-xl shadow-sm" id="active-goal-icon">üì¶</div>
                                <div>
                                    <input type="text" id="active-goal-title" class="bg-transparent border-none p-0 font-bold text-lg text-slate-800 dark:text-white focus:ring-0 w-48 transition-colors hover:bg-slate-100 dark:hover:bg-slate-700 rounded px-1" onchange="updateActiveGoal('title', this.value)">
                                    <div class="flex items-center gap-2 text-xs text-slate-500">
                                        <i class="ph-bold ph-calendar"></i>
                                        <input type="date" id="active-goal-date" class="bg-transparent border-none p-0 text-xs font-medium text-slate-500 cursor-pointer w-24 h-4 focus:ring-0" onchange="updateActiveGoal('date', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">Custo Estimado</p>
                                <p id="active-goal-total" class="text-xl font-bold text-slate-700 dark:text-slate-200">R$ 0</p>
                            </div>
                        </div>
                        <div class="flex-grow overflow-y-auto p-2 space-y-1" id="goal-items-list"></div>
                        <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 shrink-0 flex justify-between items-center gap-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="goal-safety-buffer" class="rounded text-amber-500 focus:ring-amber-500" onchange="updateActiveGoal('buffer', this.checked)">
                                <label for="goal-safety-buffer" class="text-xs font-bold text-slate-500">Margem +10%</label>
                            </div>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button onclick="deleteActiveGoal()" class="px-3 py-2 text-red-400 hover:bg-red-50 rounded-lg transition text-xs font-bold"><i class="ph-bold ph-trash"></i> Excluir</button>
                                <button onclick="addGoalItem()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-xs font-bold shadow-md shadow-indigo-200 dark:shadow-none flex items-center gap-2"><i class="ph-bold ph-plus"></i> Adicionar Item</button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 flex flex-col gap-6 h-full overflow-hidden">
                        <div class="card p-5 border-t-4 border-t-indigo-500 dark:bg-slate-800 shrink-0">
                            <h3 class="font-bold text-sm text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2"><i class="ph-fill ph-calculator text-indigo-500"></i> Viabilidade</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between text-xs"><span class="text-slate-500">Meses at√© a data</span><span id="analysis-months" class="font-bold">0</span></div>
                                <div class="flex justify-between text-xs"><span class="text-slate-500">Necessidade Mensal</span><span id="analysis-monthly-need" class="font-bold text-amber-600">R$ 0</span></div>
                                <div id="analysis-verdict" class="p-2 rounded-lg text-xs font-bold text-center bg-slate-100 text-slate-500 mt-2">...</div>
                            </div>
                        </div>
                        <div class="card p-0 flex-grow flex flex-col dark:bg-slate-800 overflow-hidden">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-red-50/30 flex justify-between items-center shrink-0">
                                <h3 class="font-bold text-sm text-slate-700 dark:text-slate-200 flex items-center gap-2"><i class="ph-fill ph-trend-down text-red-500"></i> D√≠vidas</h3>
                                <span id="total-debt-mini" class="text-xs font-bold text-red-500">R$ 0</span>
                            </div>
                            <div id="debt-list-mini" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
                            <div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-center shrink-0">
                                <button onclick="addDebtItem()" class="text-xs font-bold text-slate-400 hover:text-slate-600">+ Adicionar D√≠vida</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. ROADMAP -->
            <div id="view-roadmap" class="hidden page-transition max-w-4xl mx-auto pb-12">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center text-2xl"><i class="ph-fill ph-map-trifold"></i></div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white">Jornada do Imp√©rio</h2>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Construa seu mapa, passo a passo.</p>
                        </div>
                    </div>
                    <button onclick="promptNewPhase()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-xs font-bold shadow-md transition flex items-center gap-2"><i class="ph-bold ph-plus-circle"></i> Nova Fase</button>
                </div>
                <div class="relative space-y-8 before:absolute before:inset-0 before:ml-6 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-indigo-500 before:via-slate-200 before:to-transparent dark:before:via-slate-700" id="timeline-container"></div>
            </div>
        </div>
    </main>

    <script>
        // --- DATA & CONFIG ---
        const DEFAULT_DATA = {
            activeGoalId: 0, vaultTotal: 2500, xp: 150, streak: 3,
            vaultHistory: [{date: new Date().toISOString(), amount: 2500}],
            incomeSources: [ {id:1, name:'Sal√°rio Marcelino', value: 4500}, {id:2, name:'Sal√°rio Luiza', value: 3200} ],
            survivalBreakdown: [ 
                {id:1, name:'Aluguel+Cond', value:1800}, 
                {id:2, name:'Mercado', value:1200},
                {id:3, name:'Luz/Net/√Ågua', value:450},
                {id:4, name:'Transporte', value:300}
            ],
            goals: [
                { 
                    id: 0, title: "Casa Nova", icon: "üì¶", targetDate: "2026-06-01", useBuffer: true, 
                    items: [
                        { id: 1, name: 'Cau√ß√£o Aluguel (3x)', category: 'Taxas', cost: 5400 },
                        { id: 2, name: 'Geladeira', category: 'Eletro', cost: 3500 },
                        { id: 3, name: 'Cama Box', category: 'M√≥vel', cost: 2200 }
                    ]
                },
                { 
                    id: 1, title: "Casamento", icon: "üíç", targetDate: "2026-05-10", useBuffer: false, 
                    items: [
                        { id: 4, name: 'Taxas Cart√≥rio', category: 'Taxas', cost: 600 },
                        { id: 5, name: 'Almo√ßo', category: 'Festa', cost: 1500 }
                    ]
                }
            ],
            debts: [
                { id: 201, name: 'Cart√£o Cr√©dito', total: 2100 },
                { id: 202, name: 'Empr√©stimo Pessoal', total: 800 }
            ],
            financials: { sanity: 600 },
            timelinePhases: [
                { id: 'p0', phase: "Fase 0: Organiza√ß√£o", icon: "ph-flag", color: "bg-slate-500", tasks: [{ id: 't01', text: 'Levantar todas as d√≠vidas', checked: true }, { id: 't02', text: 'Definir teto de gastos', checked: true }] },
                { id: 'p1', phase: "Fase 1: Faxina", icon: "ph-broom", color: "bg-red-500", tasks: [{ id: 't11', text: 'Quitar d√≠vida menor', checked: false }, { id: 't12', text: 'Renegociar juros', checked: false }] },
                { id: 'p2', phase: "Fase 2: Constru√ß√£o", icon: "ph-bricks", color: "bg-indigo-500", tasks: [{ id: 't21', text: 'Juntar 50% da meta da casa', checked: false }] }
            ],
            badges: []
        };

        const CAT_GOAL = ['M√≥vel', 'Eletro', 'Taxas', 'Servi√ßo', 'Viagem', 'Festa', 'Outro'];
        const BADGES_DEF = [
            {id:'saver_1k', icon:'ph-coin', color:'text-amber-500', title:'Poupador I', desc:'Juntou R$ 1.000', req: d=>d.vaultTotal>=1000},
            {id:'saver_10k', icon:'ph-coins', color:'text-amber-600', title:'Investidor', desc:'Juntou R$ 10.000', req: d=>d.vaultTotal>=10000},
            {id:'debt_free', icon:'ph-confetti', color:'text-emerald-500', title:'Livre!', desc:'Zerou d√≠vidas', req: d=>d.debts.length>0 && d.debts.reduce((a,b)=>a+b.total,0)===0},
            {id:'score_800', icon:'ph-crown', color:'text-purple-500', title:'Imperador', desc:'Score > 800', req: ()=>{ const el=document.getElementById('kpi-score'); return el && parseInt(el.innerText)>=800; }},
            {id:'planner', icon:'ph-list-checks', color:'text-indigo-500', title:'Estrategista', desc:'5 tarefas feitas', req: d=>{let c=0; d.timelinePhases.forEach(p=>p.tasks.forEach(t=>{if(t.checked)c++})); return c>=5;}}
        ];

        let appData = {};
        let charts = {};
        let modalCallback = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initTheme();
            initChartsDefaults();
            refreshAll();
            switchTab('dashboard');
            if(!localStorage.getItem('seen_welcome_v16')) {
                const welcomeModal = document.getElementById('welcome-modal');
                if (welcomeModal) {
                    welcomeModal.classList.remove('hidden');
                    localStorage.setItem('seen_welcome_v16', 'true');
                }
            }
        });

        // --- CORE ---
        function loadData() {
            const stored = localStorage.getItem('imperioData_v16');
            if (stored) {
                appData = JSON.parse(stored);
                if(!appData.incomeSources) appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            } else {
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            }
        }
        function saveData() {
            localStorage.setItem('imperioData_v16', JSON.stringify(appData));
            showToast();
            refreshAll();
        }
        function switchTab(tabId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            const view = document.getElementById(`view-${tabId}`);
            if(view) view.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const nav = document.getElementById(`nav-${tabId}`);
            if(nav) nav.classList.add('active');
            
            if(tabId === 'projects') renderGoalTabs();
        }
        function initTheme() { if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark'); }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }
        function initChartsDefaults() { Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif"; }

        // --- REFRESH ---
        function refreshAll() {
            renderIncomeList();
            renderSurvivalList();
            updatePots(); 
            renderDebts();
            renderTimeline();
            renderGoalTabs();
            renderVault();
            updateDashboard();
            checkBadges();
            updateLevel();
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const income = appData.incomeSources.reduce((a,b)=>a+b.value,0);
            const survival = appData.survivalBreakdown.reduce((a,b)=>a+b.value,0);
            const pot = income - survival - appData.financials.sanity;
            const totalDebt = appData.debts.reduce((a,b)=>a+b.total, 0);
            const netWorth = appData.vaultTotal - totalDebt;
            const daysFreedom = pot > 0 && totalDebt > 0 ? Math.ceil(totalDebt/pot)*30 : 0;

            // KPIs
            const setEl = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; }
            setEl('dash-income', fmtMoney(income));
            setEl('kpi-networth', fmtMoney(netWorth));
            setEl('kpi-pot', fmtMoney(pot));
            setEl('kpi-freedom', totalDebt===0 ? "LIVRE!" : (pot<=0 ? "‚àû" : daysFreedom+" dias"));

            // Score
            let totalT=0, doneT=0; appData.timelinePhases.forEach(p=>p.tasks.forEach(t=>{totalT++; if(t.checked) doneT++}));
            const score = Math.round((pot>0?Math.min(400,(pot/(income||1))*1000):0) + (totalT?(doneT/totalT)*400:0) + (totalDebt===0?200:Math.max(0,200-(totalDebt/100))));
            setEl('kpi-score', score);

            // Tooltip breakdown
            setEl('sb-finance', Math.round(pot>0?Math.min(400,(pot/income)*1000):0));
            const barFin = document.getElementById('bar-finance'); if(barFin) barFin.style.width = ((pot>0?Math.min(400,(pot/income)*1000):0)/400)*100+'%';
            setEl('sb-tasks', Math.round((totalT?(doneT/totalT)*400:0)));
            const barTask = document.getElementById('bar-tasks'); if(barTask) barTask.style.width = ((totalT?(doneT/totalT)*400:0)/400)*100+'%';
            setEl('sb-debt', Math.round((totalDebt===0?200:Math.max(0,200-(totalDebt/100)))));
            const barDebt = document.getElementById('bar-debt'); if(barDebt) barDebt.style.width = ((totalDebt===0?200:Math.max(0,200-(totalDebt/100)))/200)*100+'%';

            // Projection
            const proj = appData.vaultTotal + (pot * 12);
            setEl('dash-projection', fmtMoney(proj));
            updateProjectionChart(appData.vaultTotal, pot);
            updateCashflowChart(income, survival, appData.financials.sanity, pot);
            
            // Radar
            const radarEl = document.getElementById('dashboard-goals-list');
            if(radarEl) {
                radarEl.innerHTML = appData.goals.map(g => {
                    const total = g.items.reduce((a,b)=>a+b.cost,0)*(g.useBuffer?1.1:1);
                    const globalNeed = appData.goals.reduce((acc, gl) => acc + gl.items.reduce((a,b)=>a+b.cost,0)*(gl.useBuffer?1.1:1), 0);
                    const prog = globalNeed > 0 ? (appData.vaultTotal / globalNeed) * 100 : 0;
                    return `<div><div class="flex justify-between text-xs mb-1"><span class="font-bold text-slate-700 dark:text-slate-300">${g.icon} ${g.title}</span><span class="text-slate-500">${Math.min(100, Math.round(prog))}%</span></div><div class="w-full bg-slate-100 dark:bg-slate-700 h-1.5 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width: ${Math.min(100, prog)}%"></div></div></div>`;
                }).join('');
            }
            
            // Feed
            const feedEl = document.getElementById('dash-feed');
            if(feedEl) {
                let html = '';
                if(pot < 0) html += `<div class="flex items-center gap-2 p-2 bg-red-50 text-red-600 rounded text-xs font-bold border border-red-100 mb-2"><i class="ph-bold ph-warning"></i> Aten√ß√£o: Or√ßamento Negativo!</div>`;
                appData.timelinePhases.forEach(p => p.tasks.forEach(t => { if(!t.checked) html += `<div class="flex items-center gap-3 p-2 border-b border-slate-50 dark:border-slate-800 text-xs"><div class="w-2 h-2 rounded-full bg-blue-400"></div><span class="text-slate-600 dark:text-slate-400 flex-grow">${t.text}</span></div>`; }));
                feedEl.innerHTML = html || '<div class="text-center text-xs text-slate-400">Tudo em dia!</div>';
            }
            
            setEl('dash-vault-total', fmtMoney(appData.vaultTotal));
        }

        function updateLevel() {
             const level = Math.floor(appData.xp / 1000) + 1;
             const xpCurr = appData.xp % 1000;
               const rankEl = document.getElementById('user-rank');
               if(rankEl) rankEl.innerText = `N√≠vel ${level}`;

               const xpValEl = document.getElementById('xp-val');
               if(xpValEl) xpValEl.innerText = `${xpCurr}/1000`;

               const xpValSideEl = document.getElementById('xp-val-side');
               if(xpValSideEl) xpValSideEl.innerText = `${xpCurr}/1000`;

               const xpBarEl = document.getElementById('xp-bar');
               if(xpBarEl) xpBarEl.style.width = (xpCurr/10)+'%';

               const xpBarSideEl = document.getElementById('xp-bar-side');
               if(xpBarSideEl) xpBarSideEl.style.width = (xpCurr/10)+'%';

               const xpLevelDisplay = document.getElementById('xp-level-display');
               if(xpLevelDisplay) xpLevelDisplay.innerText = level;
        }

        // --- CHARTS ---
        function updateCashflowChart(inc, surv, san, pot) {
            const ctx = document.getElementById('cashflowChart');
            if(!ctx) return;
            if(charts.cash) charts.cash.destroy();
            charts.cash = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Entrada', 'Sa√≠das'],
                    datasets: [
                        { label: 'Renda', data: [inc, 0], backgroundColor: '#6366f1', borderRadius: 4 },
                        { label: 'Fixo', data: [0, surv], backgroundColor: '#64748b', borderRadius: 4 },
                        { label: 'Lazer', data: [0, san], backgroundColor: '#f59e0b', borderRadius: 4 },
                        { label: 'Futuro', data: [0, Math.max(0,pot)], backgroundColor: '#10b981', borderRadius: 4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid:{display:false} }, y: { stacked: true, display:false } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } }
            });
        }

        function updateProjectionChart(start, monthly) {
            const ctx = document.getElementById('projectionChart');
            if(!ctx) return;
            if(charts.proj) charts.proj.destroy();
            charts.proj = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Hoje', '3M', '6M', '12M'],
                    datasets: [{
                        label: 'Patrim√¥nio',
                        data: [start, start+(monthly*3), start+(monthly*6), start+(monthly*12)],
                        borderColor: '#fbbf24', backgroundColor: 'rgba(251, 191, 36, 0.1)', fill: true, tension: 0.4, pointRadius: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: {x:{display:false}, y:{display:false}} }
            });
        }

        // --- FINANCE CRUD ---
        function renderIncomeList() {
            const el = document.getElementById('income-list');
            if(el) el.innerHTML = appData.incomeSources.map((inc, i) => `
                <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-slate-900 rounded mb-1">
                    <input value="${inc.name}" onchange="appData.incomeSources[${i}].name=this.value;saveData()" class="bg-transparent text-sm w-full outline-none text-slate-700 dark:text-slate-300">
                    <input type="number" value="${inc.value}" onchange="appData.incomeSources[${i}].value=parseFloat(this.value)||0;saveData()" class="bg-transparent text-sm text-right w-20 font-bold outline-none text-slate-700 dark:text-slate-300">
                    <button onclick="appData.incomeSources.splice(${i},1);saveData()" class="text-slate-400 hover:text-red-500 px-1">√ó</button>
                </div>`).join('');
            const total = appData.incomeSources.reduce((a,b)=>a+b.value,0);
            if(document.getElementById('total-income-display')) document.getElementById('total-income-display').innerText = fmtMoney(total);
        }
        function addIncomeSource() { appData.incomeSources.push({id:Date.now(), name:'Nova Renda', value:0}); saveData(); }

        function renderSurvivalList() {
            const el = document.getElementById('survival-list');
            if(el) el.innerHTML = appData.survivalBreakdown.map((item, i) => `
                <div class="flex items-center gap-2 text-xs border-b border-slate-100 dark:border-slate-700 pb-1 mb-1">
                    <input value="${item.name}" onchange="appData.survivalBreakdown[${i}].name=this.value; saveData()" class="flex-grow bg-transparent outline-none text-slate-600 dark:text-slate-400">
                    <input type="number" value="${item.value}" onchange="appData.survivalBreakdown[${i}].value=parseFloat(this.value)||0; saveData()" class="w-16 text-right bg-transparent outline-none font-bold text-slate-600 dark:text-slate-400">
                    <button onclick="appData.survivalBreakdown.splice(${i},1); saveData()" class="text-slate-300 hover:text-red-500">√ó</button>
                </div>`).join('');
            
            const total = appData.survivalBreakdown.reduce((a,b)=>a+b.value,0);
            if(document.getElementById('survival-display')) document.getElementById('survival-display').innerText = fmtMoney(total);
            
            const modalList = document.getElementById('calc-items-list');
            if(modalList) modalList.innerHTML = appData.survivalBreakdown.map((item, i) => `
                <div class="flex items-center gap-2 p-2 border border-slate-100 rounded mb-2">
                    <input value="${item.name}" onchange="appData.survivalBreakdown[${i}].name=this.value; saveData()" class="flex-grow bg-transparent outline-none text-sm font-medium">
                    <input type="number" value="${item.value}" onchange="appData.survivalBreakdown[${i}].value=parseFloat(this.value)||0; saveData(); renderSurvivalList()" class="w-24 text-right bg-slate-50 rounded p-1 text-sm font-bold">
                    <button onclick="appData.survivalBreakdown.splice(${i},1); saveData(); renderSurvivalList()" class="text-red-400 px-2">√ó</button>
                </div>`).join('');
            if(document.getElementById('calc-total')) document.getElementById('calc-total').innerText = fmtMoney(total);
        }
        function addSurvivalItem() { appData.survivalBreakdown.push({id:Date.now(), name:'Item', value:0}); saveData(); }
        function toggleCalc(show) { const m=document.getElementById('calc-modal'); if(m) { m.classList.toggle('hidden', !show); if(show) renderSurvivalList(); } }
        function applyCalc() { toggleCalc(false); }
        
        function syncSlider(t) { 
            if(t==='sanity') { appData.financials.sanity = parseFloat(document.getElementById('sanity-slider').value); saveData(); }
        }
        
        function updatePots() {
            const sanity = appData.financials.sanity;
            if(document.getElementById('sanity-slider')) document.getElementById('sanity-slider').value = sanity;
            if(document.getElementById('sanity-display')) document.getElementById('sanity-display').innerText = fmtMoney(sanity);
            if(document.getElementById('future-pot-display')) document.getElementById('future-pot-display').innerText = fmtMoney(appData.incomeSources.reduce((a,b)=>a+b.value,0) - appData.survivalBreakdown.reduce((a,b)=>a+b.value,0) - sanity);
        }

        // --- PROJECTS (SAFE RENDER) ---
        function promptNewGoal() { showInputModal("Nome da Meta", val => { if(val) { appData.goals.push({id:Date.now(), title:val, icon:"üéØ", targetDate:"2026-12-31", useBuffer:false, items:[]}); appData.activeGoalId=appData.goals.length-1; saveData(); } }); }
        
        function renderGoalTabs() {
            const c = document.getElementById('goal-tabs-container');
            if(!c) return;
            c.innerHTML = appData.goals.map((g, i) => `
                <button onclick="appData.activeGoalId=${i}; saveData(); renderGoalTabs()" class="px-4 py-2 text-sm font-medium rounded-t-lg whitespace-nowrap transition ${i===appData.activeGoalId ? 'bg-white dark:bg-slate-800 text-indigo-600 border-t-2 border-indigo-500' : 'text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800'}">
                    ${g.icon} ${g.title}
                </button>`).join('');
            renderActiveGoal();
        }
        
        function renderActiveGoal() {
            const goal = appData.goals[appData.activeGoalId];
            if(!goal) return;
            
            const safeSet = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; }
            const safeText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; }
            
            safeSet('active-goal-title', goal.title);
            safeText('active-goal-icon', goal.icon);
            safeSet('active-goal-date', goal.targetDate);
            const buf = document.getElementById('goal-safety-buffer'); if(buf) buf.checked = goal.useBuffer;
            
            const list = document.getElementById('goal-items-list');
            if(list) {
                let total = 0;
                list.innerHTML = goal.items.map((item, i) => {
                    total += item.cost;
                    return `
                    <div class="flex gap-2 p-2 border-b border-slate-100 dark:border-slate-700 items-center group">
                        <input value="${item.name}" onchange="updateGoalItem(${i},'name',this.value)" class="flex-grow bg-transparent outline-none text-sm text-slate-600 dark:text-slate-300">
                        <input type="number" value="${item.cost}" onchange="updateGoalItem(${i},'cost',parseFloat(this.value))" class="w-20 text-right bg-transparent outline-none text-sm font-bold">
                        <button onclick="deleteGoalItem(${i})" class="opacity-0 group-hover:opacity-100 text-red-400">√ó</button>
                    </div>`;
                }).join('');
                const finalTotal = goal.useBuffer ? total * 1.1 : total;
                safeText('active-goal-total', fmtMoney(finalTotal));
                
                const verdict = document.getElementById('analysis-verdict');
                if(verdict) {
                    const income = appData.incomeSources.reduce((a,b)=>a+b.value,0);
                    const survival = appData.survivalBreakdown.reduce((a,b)=>a+b.value,0);
                    const pot = income - survival - appData.financials.sanity;
                    const months = Math.max(1, (new Date(goal.targetDate) - new Date()) / (1000*60*60*24*30));
                    const mNeed = finalTotal/months;
                    safeText('analysis-months', Math.ceil(months) + " meses");
                    safeText('analysis-monthly-need', fmtMoney(mNeed));
                    
                    if(pot >= mNeed) { verdict.className="p-2 rounded-lg text-xs font-bold text-center bg-emerald-100 text-emerald-700 mt-2"; verdict.innerText = "‚úÖ Vi√°vel!"; }
                    else { verdict.className="p-2 rounded-lg text-xs font-bold text-center bg-red-100 text-red-700 mt-2"; verdict.innerText = `‚ö†Ô∏è Faltam R$ ${Math.round(mNeed-pot)}`; }
                }
            }
        }
        function updateGoalItem(i,f,v) { appData.goals[appData.activeGoalId].items[i][f] = v; saveData(); }
        function addGoalItem() { appData.goals[appData.activeGoalId].items.push({id:Date.now(), name:'', category:'Outro', cost:0}); saveData(); }
        function deleteGoalItem(i) { appData.goals[appData.activeGoalId].items.splice(i,1); saveData(); }
        function deleteActiveGoal() { if(confirm("Deletar?")) { appData.goals.splice(appData.activeGoalId,1); appData.activeGoalId=0; saveData(); } }
        function updateActiveGoal(f,v) { const g=appData.goals[appData.activeGoalId]; if(f==='title')g.title=v; if(f==='date')g.targetDate=v; if(f==='buffer')g.useBuffer=v; saveData(); }

        // --- DEBTS ---
        function renderDebts() {
            const list = document.getElementById('debt-list-mini');
            if(!list) return;
            let total = 0;
            list.innerHTML = appData.debts.map((d,i) => {
                total += d.total;
                return `
                <div class="flex items-center justify-between p-2 border-b border-slate-100 dark:border-slate-700 text-xs">
                    <input value="${d.name}" onchange="appData.debts[${i}].name=this.value;saveData()" class="bg-transparent outline-none font-medium text-slate-600 dark:text-slate-300 w-24">
                    <input type="number" value="${d.total}" onchange="appData.debts[${i}].total=parseFloat(this.value)||0;saveData()" class="bg-transparent outline-none font-bold text-red-500 text-right w-20">
                    <button onclick="appData.debts.splice(${i},1);saveData()" class="text-slate-300 hover:text-red-500">√ó</button>
                </div>`;
            }).join('');
            if(document.getElementById('total-debt-mini')) document.getElementById('total-debt-mini').innerText = fmtMoney(total);
        }
        function addDebtItem() { appData.debts.push({id:Date.now(), name:'Nova', total:0}); saveData(); }

        // --- TIMELINE ---
        function promptNewPhase() { showInputModal("Nome da Fase", v => { if(v) { appData.timelinePhases.push({id:Date.now(), phase:v, icon:"ph-flag", color:"bg-slate-500", tasks:[]}); saveData(); } }); }
        function renderTimeline() {
            const el = document.getElementById('timeline-container');
            if(!el) return;
            el.innerHTML = appData.timelinePhases.map((p, i) => `
                <div class="relative pl-8 pb-8 border-l-2 border-slate-200 dark:border-slate-700 last:border-0 ml-4">
                    <div class="absolute -left-[11px] top-0 w-6 h-6 rounded-full border-2 border-white dark:border-slate-900 ${p.color} text-white flex items-center justify-center shadow-sm"><i class="ph-bold ${p.icon} text-xs"></i></div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex justify-between items-center mb-2">
                            <input value="${p.phase}" onchange="appData.timelinePhases[${i}].phase=this.value; saveData()" class="font-bold text-sm bg-transparent outline-none text-slate-800 dark:text-white">
                            <div class="flex gap-2">
                                <button onclick="deletePhase(${i})" class="text-slate-300 hover:text-red-500"><i class="ph-bold ph-trash"></i></button>
                                <button onclick="addPhaseTask(${i})" class="text-indigo-500 font-bold text-xs">+ Passo</button>
                            </div>
                        </div>
                        <div class="space-y-1">
                            ${p.tasks.map((t, ti) => `<div class="flex items-center gap-2 group">
                                <input type="checkbox" ${t.checked?'checked':''} onchange="toggleTask(${i},${ti})" class="accent-indigo-500 cursor-pointer">
                                <input value="${t.text}" onchange="appData.timelinePhases[${i}].tasks[${ti}].text=this.value; saveData()" class="text-xs bg-transparent outline-none w-full ${t.checked?'line-through text-slate-400':'text-slate-600 dark:text-slate-300'}">
                                <button onclick="appData.timelinePhases[${i}].tasks.splice(${ti},1); saveData()" class="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 text-xs">√ó</button>
                            </div>`).join('')}
                        </div>
                    </div>
                </div>`).join('');
        }
        function toggleTask(p,t) { 
            appData.timelinePhases[p].tasks[t].checked = !appData.timelinePhases[p].tasks[t].checked; 
            if(appData.timelinePhases[p].tasks[t].checked) { appData.xp += 100; confetti({particleCount:40,spread:50,origin:{y:0.7}}); }
            saveData(); 
        }
        function addPhaseTask(i) { appData.timelinePhases[i].tasks.push({id:Date.now(), text:"Novo passo", checked:false}); saveData(); }
        function deletePhase(i) { if(confirm("Deletar fase?")) { appData.timelinePhases.splice(i,1); saveData(); } }

        // --- BADGES ---
        function checkBadges() {
            const c = document.getElementById('badges-container');
            if(c) {
                const unlocked = new Set(appData.badges);
                c.innerHTML = BADGES_DEF.map(b => {
                    const has = b.req ? b.req(appData) : false;
                    if(has && !unlocked.has(b.id)) { appData.badges.push(b.id); confetti(); }
                    const unlockedNow = appData.badges.includes(b.id);
                    return `<div class="flex items-center justify-center p-2 rounded bg-slate-50 dark:bg-slate-900 ${unlockedNow?'shadow-sm badge-unlocked':'opacity-30 grayscale'} text-2xl group relative cursor-help">
                        <i class="ph-fill ${b.icon} ${b.color}"></i>
                        <div class="absolute bottom-full mb-2 w-24 bg-slate-900 text-white text-[10px] p-2 rounded shadow opacity-0 invisible group-hover:visible z-50 pointer-events-none">${b.title}</div>
                    </div>`;
                }).join('');
                const count = document.getElementById('dash-badge-count');
                if(count) count.innerText = `${appData.badges.length}/${BADGES_DEF.length}`;
            }
        }

        // --- ACTIONS ---
        function quickDeposit() { showInputModal("Valor para Guardar", v=>{ if(v && parseFloat(v)) { appData.vaultTotal += parseFloat(v); appData.xp+=50; confetti(); saveData(); } }); }
        function incrementStreak() { appData.streak++; appData.xp+=20; saveData(); confetti({particleCount:20,spread:30}); }

        // --- MODAL UTILS ---
        function showInputModal(title, callback) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-input').value = '';
            document.getElementById('input-modal').classList.remove('hidden');
            document.getElementById('modal-input').focus();
            modalCallback = callback;
        }
        function closeInputModal() { document.getElementById('input-modal').classList.add('hidden'); }
        document.getElementById('modal-confirm-btn').onclick = () => { if(modalCallback) modalCallback(document.getElementById('modal-input').value); closeInputModal(); };
        function closeModal() {
            const welcomeModal = document.getElementById('welcome-modal');
            if (welcomeModal) welcomeModal.classList.add('hidden');
        }

        // --- UTILS ---
        function fmtMoney(n) { return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function showToast() { const t=document.getElementById('last-saved'); if(t) { t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000); } }
        function downloadData() { const blob = new Blob([JSON.stringify(appData)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `empire_os_backup.json`; a.click(); }
        function uploadData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { if(confirm("Restaurar?")) { appData = JSON.parse(e.target.result); saveData(); location.reload(); }}; r.readAsText(f); }
        function resetAllData() { if(confirm("Reiniciar tudo?")) { localStorage.removeItem('imperioData_v17'); localStorage.removeItem('seen_welcome_v17'); location.reload(); } }
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }
        function updateChart(id, type, labels, data, colors) {
            const el = document.getElementById(id);
            if(!el) return;
            if(charts[id]) charts[id].destroy();
            const ctx = el.getContext('2d');
            charts[id] = new Chart(ctx, { type, data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } } });
        }
        function initChartsDefaults() { Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif"; }
        function renderVault() {
            if(document.getElementById('vault-total')) document.getElementById('vault-total').innerText = fmtMoney(appData.vaultTotal);
            
            const totalGoal = appData.goals.reduce((acc, g) => acc + g.items.reduce((a,b)=>a+b.cost,0)*(g.useBuffer?1.1:1), 0) + appData.debts.reduce((a,b)=>a+b.total,0);
            if(document.getElementById('vault-goal')) document.getElementById('vault-goal').innerText = fmtMoney(totalGoal);
            
            const prog = totalGoal > 0 ? (appData.vaultTotal / totalGoal) * 100 : 0;
            if(document.getElementById('vault-progress')) document.getElementById('vault-progress').style.width = Math.min(100, prog) + '%';

            const hist = document.getElementById('vault-history');
            if(hist) {
                if(appData.vaultHistory.length > 0) {
                    hist.innerHTML = appData.vaultHistory.slice(-3).reverse().map(h => `<li class="flex justify-between border-b border-slate-100 dark:border-slate-800 pb-1 last:border-0 text-xs"><span>${new Date(h.date).toLocaleDateString()}</span><span class="font-bold text-emerald-500">+${fmtMoney(h.amount)}</span></li>`).join('');
                } else { hist.innerHTML = '<li class="italic text-slate-400">Sem hist√≥rico.</li>'; }
            }
        }
    </script>
</body>
</html>