<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro Pessoal</title>
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Maps -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "react-router-dom": "https://esm.sh/react-router-dom@6.22.3?external=react,react-dom",
        "zustand": "https://esm.sh/zustand@4.5.2?external=react",
        "zustand/middleware": "https://esm.sh/zustand@4.5.2/middleware?external=react",
        "clsx": "https://esm.sh/clsx",
        "tailwind-merge": "https://esm.sh/tailwind-merge",
        "lucide-react": "https://esm.sh/lucide-react@0.363.0?external=react",
        "date-fns": "https://esm.sh/date-fns@3.6.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js"
      }
    }
    </script>
    
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              neutral: {
                50: '#f8fafc',
                100: '#f1f5f9',
                200: '#e2e8f0',
                300: '#cbd5e1',
                400: '#94a3b8',
                500: '#64748b',
                600: '#475569',
                700: '#334155',
                800: '#1e293b',
                900: '#0f172a',
                950: '#020617'
              },
              primary: {
                50: '#ecfdf5',
                100: '#d1fae5',
                200: '#a7f3d0',
                300: '#6ee7b7',
                400: '#34d399',
                500: '#10b981',
                600: '#059669',
                700: '#047857',
                800: '#065f46',
                900: '#064e3b',
                950: '#022c22'
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif']
            }
          }
        }
      }
    </script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { HashRouter, Routes, Route, NavLink } from 'react-router-dom';
      import { create } from 'zustand';
      import clsx from 'clsx';
      import { twMerge } from 'tailwind-merge';
      import { 
        LayoutDashboard,
        ListOrdered,
        UploadCloud,
        Settings as SettingsIcon,
        Menu,
        X,
        ArrowUpCircle,
        ArrowDownCircle,
        Wallet,
        Calendar,
        CreditCard
      } from 'lucide-react';
      import { format, parseISO } from 'date-fns';
      import { initializeApp } from 'firebase/app';
      import { 
        getDatabase,
        ref,
        get,
        set,
        push,
        update,
        remove,
        onValue,
        child
      } from 'firebase/database';
      
      // ============================================================================
      // FIREBASE CONFIGURATION
      // ============================================================================
      
      /**
       * üî• COLE SUA CONFIGURA√á√ÉO DO FIREBASE AQUI üî•
       * 
       * Substitua o objeto abaixo pela sua configura√ß√£o real do Firebase Console:
       * 1. Acesse https://console.firebase.google.com
       * 2. Selecione seu projeto
       * 3. V√° em Project Settings > General
       * 4. Em "Your apps", copie o firebaseConfig
       * 5. Cole aqui substituindo os valores de exemplo
       */
const firebaseConfig = {
  apiKey: "AIzaSyAIXU9oqsbzFHEQ0Vdx2uBpTrdGk2YSOS8",
  authDomain: "contaconjunta-marc35.firebaseapp.com",
  databaseURL: "https://contaconjunta-marc35-default-rtdb.firebaseio.com",
  projectId: "contaconjunta-marc35",
  storageBucket: "contaconjunta-marc35.firebasestorage.app",
  messagingSenderId: "193293125640",
  appId: "1:193293125640:web:7952ebbb4f3bd5fb4a69bd",
  measurementId: "G-VJ61KTVCV8"
};

      
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      
      /**
       * üìä ESTRUTURA DO FIREBASE REALTIME DATABASE
       * 
       * usuarios_app/
       *   ‚îú‚îÄ marcelino/
       *   ‚îÇ    ‚îî‚îÄ senha: "senha123"
       *   ‚îú‚îÄ luiza/
       *   ‚îÇ    ‚îî‚îÄ senha: "senha123"
       *   ‚îî‚îÄ casal/
       *        ‚îî‚îÄ senha: "senha123"
       * 
       * transactions/
       *   ‚îú‚îÄ marcelino/
       *   ‚îÇ    ‚îî‚îÄ {transactionId}: { ...transactionData, ownerId: "marcelino" }
       *   ‚îú‚îÄ luiza/
       *   ‚îÇ    ‚îî‚îÄ {transactionId}: { ...transactionData, ownerId: "luiza" }
       *   ‚îî‚îÄ casalusuario/
       *        ‚îî‚îÄ {transactionId}: { ...transactionData, ownerId: "casalusuario" }
       * 
       * LOGIN COMO 'casal':
       *   - Perfil Admin: V√™ TODAS transa√ß√µes (marcelino + luiza + casalusuario)
       *   - Perfil Conta Conjunta: V√™ APENAS transa√ß√µes de casalusuario
       * 
       * üîí ARQUITETURA ZERO-LOCALSTORAGE:
       *   - TUDO √© armazenado no Firebase Realtime Database
       *   - Zustand √© usado apenas para estado em mem√≥ria durante a sess√£o
       *   - Ao recarregar: Login ‚Üí Carrega do Firebase ‚Üí Popula Zustand
       *   - Ao criar: Add no Zustand ‚Üí useEffect detecta ‚Üí Salva no Firebase
       *   - Real-time listener sincroniza mudan√ßas de outros dispositivos
       *   - Logout limpa completamente o estado em mem√≥ria
       */
      
      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================
      
      /**
       * Merge classes with Tailwind CSS conflict resolution
       * @param {...any} inputs - Class names to merge
       * @returns {string} Merged class names
       */
      const cn = (...inputs) => {
        return twMerge(clsx(inputs));
      };
      
      /**
       * Format numbers as BRL currency
       * @param {number} value
       * @returns {string}
       */
      const formatCurrency = (value = 0) => {
        return new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(value || 0);
      };
      
      /**
       * Safely parse ISO date strings
       * @param {string} value
       * @returns {Date|null}
       */
      const parseToDate = (value) => {
        if (!value) return null;
        try {
          const parsed = parseISO(value);
          return Number.isNaN(parsed?.getTime()) ? null : parsed;
        } catch (error) {
          return null;
        }
      };
      
      /**
       * Check if date is in target month/year
       * @param {string} value
       * @param {number} month
       * @param {number} year
       * @returns {boolean}
       */
      const isSameMonthYear = (value, month, year) => {
        const date = parseToDate(value);
        if (!date || !month || !year) return false;
        return date.getMonth() + 1 === month && date.getFullYear() === year;
      };
      
      /**
       * Format ISO date to dd/MM/yyyy
       * @param {string} value
       * @returns {string}
       */
      const formatDateLabel = (value) => {
        const date = parseToDate(value);
        if (!date) return '‚Äî';
        return format(date, 'dd/MM/yyyy');
      };
      
      // ============================================================================
      // CREDIT CARD ENGINE
      // ============================================================================
      
      /**
       * Calculate installment transactions for credit card purchases
       * @param {number} totalAmount - Total purchase amount
       * @param {number} installmentsCount - Number of installments
       * @param {string} purchaseDate - Purchase date (ISO string)
       * @param {number} cardClosingDay - Card closing day (1-31)
       * @returns {Array<{dueDate: string, amount: number, installment: {current: number, total: number}}>}
       */
      const calculateInstallments = (totalAmount, installmentsCount, purchaseDate, cardClosingDay) => {
        if (!totalAmount || !installmentsCount || installmentsCount < 1) {
          return [];
        }
        
        const purchaseDateObj = parseToDate(purchaseDate);
        if (!purchaseDateObj) {
          return [];
        }
        
        // Calculate base installment value and remainder
        const baseInstallmentValue = Math.floor((totalAmount * 100) / installmentsCount) / 100;
        const remainder = Math.round((totalAmount - baseInstallmentValue * installmentsCount) * 100) / 100;
        
        // Determine first installment month
        const purchaseDay = purchaseDateObj.getDate();
        let firstInstallmentMonth = purchaseDateObj.getMonth();
        let firstInstallmentYear = purchaseDateObj.getFullYear();
        
        // If purchase was made on or after closing day, push to next billing cycle
        if (purchaseDay >= cardClosingDay) {
          firstInstallmentMonth += 1;
          if (firstInstallmentMonth > 11) {
            firstInstallmentMonth = 0;
            firstInstallmentYear += 1;
          }
        }
        
        // Generate installments
        const installments = [];
        for (let i = 0; i < installmentsCount; i++) {
          const installmentMonth = (firstInstallmentMonth + i) % 12;
          const installmentYear = firstInstallmentYear + Math.floor((firstInstallmentMonth + i) / 12);
          
          // Add remainder to first installment to ensure exact total
          const installmentAmount = i === 0 
            ? baseInstallmentValue + remainder 
            : baseInstallmentValue;
          
          // Create due date (typically 5-10 days after closing, using 10 as default)
          const dueDay = Math.min(cardClosingDay + 10, 28); // Avoid invalid dates
          const dueDate = new Date(installmentYear, installmentMonth, dueDay);
          
          installments.push({
            dueDate: dueDate.toISOString(),
            amount: installmentAmount,
            installment: {
              current: i + 1,
              total: installmentsCount
            }
          });
        }
        
        return installments;
      };
      
      /**
       * Validate if installment calculation is correct
       * @param {Array} installments
       * @param {number} expectedTotal
       * @returns {boolean}
       */
      const validateInstallmentsTotal = (installments, expectedTotal) => {
        const calculatedTotal = installments.reduce((sum, inst) => sum + inst.amount, 0);
        return Math.abs(calculatedTotal - expectedTotal) < 0.01; // Allow 1 cent tolerance
      };
      
      /**
       * Get owner display name from ownerId
       * @param {string} ownerId
       * @returns {string}
       */
      const getOwnerName = (ownerId) => {
        const ownerMap = {
          'marcelino': 'Marcelino',
          'luiza': 'Luiza',
          'casalusuario': 'Casal'
        };
        return ownerMap[ownerId] || ownerId;
      };
      
      // ============================================================================
      // OFX PARSER
      // ============================================================================
      
      /**
       * Parse OFX date format (YYYYMMDDHHMMSS) to ISO string
       * @param {string} ofxDate - Date in OFX format
       * @returns {string|null} ISO date string or null if invalid
       */
      const parseOFXDate = (ofxDate) => {
        if (!ofxDate || ofxDate.length < 8) return null;
        
        try {
          const year = ofxDate.substring(0, 4);
          const month = ofxDate.substring(4, 6);
          const day = ofxDate.substring(6, 8);
          const hour = ofxDate.substring(8, 10) || '00';
          const minute = ofxDate.substring(10, 12) || '00';
          const second = ofxDate.substring(12, 14) || '00';
          
          const date = new Date(
            parseInt(year),
            parseInt(month) - 1,
            parseInt(day),
            parseInt(hour),
            parseInt(minute),
            parseInt(second)
          );
          
          if (isNaN(date.getTime())) {
            return null;
          }
          
          return date.toISOString();
        } catch (error) {
          console.error('Error parsing OFX date:', ofxDate, error);
          return null;
        }
      };
      
      /**
       * Parse OFX amount (handles negative values)
       * @param {string} amount - Amount string from OFX
       * @returns {number} Parsed amount
       */
      const parseOFXAmount = (amount) => {
        if (!amount) return 0;
        const cleaned = amount.trim().replace(/,/g, '');
        return parseFloat(cleaned) || 0;
      };
      
      /**
       * Extract value from OFX tag
       * @param {string} content - OFX content
       * @param {string} tag - Tag name without brackets
       * @returns {string} Extracted value or empty string
       */
      const extractOFXTag = (content, tag) => {
        const regex = new RegExp(`<${tag}>([^<]*)`);
        const match = content.match(regex);
        return match ? match[1].trim() : '';
      };
      
      /**
       * Parse OFX file content and extract transactions
       * @param {string} fileContent - Raw OFX file content
       * @returns {Array<{date: string, amount: number, type: string, description: string, fitId: string}>}
       */
      const parseOFX = (fileContent) => {
        if (!fileContent || typeof fileContent !== 'string') {
          console.error('Invalid OFX content');
          return [];
        }
        
        const transactions = [];
        
        // Extract all STMTTRN blocks using regex
        const transactionRegex = /<STMTTRN>([\s\S]*?)<\/STMTTRN>/gi;
        let match;
        
        while ((match = transactionRegex.exec(fileContent)) !== null) {
          const block = match[1];
          
          try {
            // Extract fields from transaction block
            const dtPosted = extractOFXTag(block, 'DTPOSTED');
            const trnAmt = extractOFXTag(block, 'TRNAMT');
            const memo = extractOFXTag(block, 'MEMO');
            const fitId = extractOFXTag(block, 'FITID');
            const trnType = extractOFXTag(block, 'TRNTYPE');
            const checkNum = extractOFXTag(block, 'CHECKNUM');
            
            // Parse date and amount
            const date = parseOFXDate(dtPosted);
            const amount = parseOFXAmount(trnAmt);
            
            if (!date || amount === 0) {
              console.warn('Skipping invalid transaction:', { dtPosted, trnAmt });
              continue;
            }
            
            // Determine transaction type (income/expense)
            const type = amount > 0 ? 'income' : 'expense';
            const absoluteAmount = Math.abs(amount);
            
            // Build description
            let description = memo || trnType || 'Transa√ß√£o importada';
            if (checkNum) {
              description += ` (Cheque ${checkNum})`;
            }
            
            transactions.push({
              date,
              amount: absoluteAmount,
              type,
              description: description.trim(),
              fitId: fitId || `${dtPosted}_${trnAmt}`,
              category: '', // Will be set by user
              paymentMethod: 'debit' // Default
            });
          } catch (error) {
            console.error('Error parsing transaction block:', error, block);
          }
        }
        
        console.log(`Parsed ${transactions.length} transactions from OFX`);
        return transactions;
      };
      
      /**
       * Read file content as text
       * @param {File} file
       * @returns {Promise<string>}
       */
      const readFileAsText = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = (e) => reject(e);
          reader.readAsText(file, 'ISO-8859-1'); // Brazilian banks often use this encoding
        });
      };
      
      /**
       * Debounce function to limit execution rate
       * @param {Function} func - Function to debounce
       * @param {number} wait - Wait time in milliseconds
       * @returns {Function} Debounced function
       */
      const debounce = (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      };
      
      // ============================================================================
      // TYPE DEFINITIONS (JSDoc)
      // ============================================================================
      
      /**
       * @typedef {Object} TransactionInstallments
       * @property {number} current - Current installment number
       * @property {number} total - Total number of installments
       */
      
      /**
       * @typedef {Object} Transaction
       * @property {string} id - Unique identifier
       * @property {string} description - Transaction description
       * @property {number} amount - Transaction amount (positive number)
       * @property {'income'|'expense'} type - Transaction type
       * @property {string} date - ISO date string
       * @property {string} category - Transaction category
       * @property {'credit'|'debit'} paymentMethod - Payment method
       * @property {TransactionInstallments|null} installments - Installment info (null for single payment)
       * @property {string} userId - User ID who created this transaction (for auth)
       * @property {string} ownerId - Owner ID ('marcelino', 'luiza', or 'casalusuario' for shared)
       * @property {string} [fitId] - OFX FITID for duplicate detection
       */
      
      /**
       * @typedef {Object} Account
       * @property {string} id - Unique identifier
       * @property {string} name - Account name (e.g., "Banco Ita√∫", "Carteira")
       * @property {string} type - Account type (e.g., "bank", "wallet", "investment")
       * @property {number} balance - Current balance
       * @property {string} userId - User ID who owns this account
       */
      
      /**
       * @typedef {Object} GlobalFilter
       * @property {number|null} month - Filter month (1-12, null for all)
       * @property {number|null} year - Filter year (null for all)
       */
      
      /**
       * @typedef {Object} User
       * @property {string} id - User ID ('marcelino', 'luiza', 'casal', 'casalusuario')
       * @property {string} email - User email
       * @property {string} name - User display name
       * @property {'user_a'|'user_b'|'admin'|'usuario_c'} type - User type/role
       */
      
      /**
       * @typedef {Object} AppState
       * @property {User|null} currentUser - Currently logged in user
       * @property {Transaction[]} transactions - List of all transactions
       * @property {Account[]} accounts - List of all accounts
       * @property {boolean} isSidebarOpen - Sidebar open/closed state
       * @property {GlobalFilter} globalFilter - Global date filter
       */
      
      /**
       * @typedef {Object} AppActions
       * @property {(transaction: Omit<Transaction, 'id'>) => void} addTransaction - Add new transaction
       * @property {(id: string) => void} removeTransaction - Remove transaction by ID
       * @property {(id: string, updates: Partial<Transaction>) => void} updateTransaction - Update transaction
       * @property {(filter: Partial<GlobalFilter>) => void} setGlobalFilter - Set date filter
       * @property {(user: User|null) => void} setCurrentUser - Set current user
       * @property {(isOpen: boolean) => void} setSidebarOpen - Toggle sidebar
       * @property {(account: Omit<Account, 'id'>) => void} addAccount - Add new account
       * @property {(id: string) => void} removeAccount - Remove account by ID
       */
      
      /** @typedef {AppState & AppActions} AppStore */
      
      // ============================================================================
      // SESSION MANAGEMENT (HYBRID APPROACH)
      // ============================================================================
      /**
       * üî• ARQUITETURA H√çBRIDA:
       * - Sess√£o do usu√°rio (currentUser) ‚Üí localStorage (mant√©m login)
       * - Transa√ß√µes e dados ‚Üí Firebase Realtime Database (fonte √∫nica)
       * - Melhor UX + Integridade de dados
       */
      
      const SESSION_KEY = 'financial-app-session';
      
      const SessionManager = {
        save: (user) => {
          if (user) {
            localStorage.setItem(SESSION_KEY, JSON.stringify(user));
          }
        },
        load: () => {
          try {
            const data = localStorage.getItem(SESSION_KEY);
            return data ? JSON.parse(data) : null;
          } catch {
            return null;
          }
        },
        clear: () => {
          localStorage.removeItem(SESSION_KEY);
        }
      };
      
      // ============================================================================
      // ZUSTAND STORE (IN-MEMORY ONLY - NO PERSISTENCE)
      // ============================================================================
      
      const useAppStore = create((set, get) => ({
            // ========== STATE ==========
            currentUser: null,
            transactions: [],
            accounts: [],
            isSidebarOpen: true,
            globalFilter: {
              month: null,
              year: null
            },
            
            // ========== ACTIONS ==========
            
            /**
             * Add a new transaction
             * @param {Omit<Transaction, 'id'>} transaction
             */
            addTransaction: (transaction) => {
              const newTransaction = {
                ...transaction,
                id: transaction.id || `txn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
              };
              
              console.log('‚ûï Adding transaction to store:', {
                id: newTransaction.id,
                ownerId: newTransaction.ownerId,
                userId: newTransaction.userId,
                description: newTransaction.description
              });
              
              set((state) => {
                // Check if transaction already exists (prevent duplicates)
                const exists = state.transactions.some(t => t.id === newTransaction.id);
                if (exists) {
                  console.warn('‚ö†Ô∏è Transaction already exists, skipping:', newTransaction.id);
                  return state;
                }
                
                return {
                  transactions: [...state.transactions, newTransaction]
                };
              });
            },
            
            /**
             * Update transaction by ID
             * @param {string} id
             * @param {Partial<Transaction>} updates
             */
            updateTransaction: (id, updates) => {
              console.log('‚úèÔ∏è Updating transaction in store:', id, updates);
              set((state) => ({
                transactions: state.transactions.map(t => 
                  t.id === id ? { ...t, ...updates, updatedAt: new Date().toISOString() } : t
                )
              }));
            },
            
            /**
             * Remove transaction by ID
             * @param {string} id
             */
            removeTransaction: (id) => {
              set((state) => ({
                transactions: state.transactions.filter(t => t.id !== id)
              }));
            },
            
            /**
             * Clear all transactions
             */
            clearTransactions: () => {
              console.log('üßπ Clearing all transactions from store');
              set({ transactions: [] });
            },
            
            /**
             * Set global date filter
             * @param {Partial<GlobalFilter>} filter
             */
            setGlobalFilter: (filter) => {
              set((state) => ({
                globalFilter: {
                  ...state.globalFilter,
                  ...filter
                }
              }));
            },
            
            /**
             * Set current user (also saves to localStorage for session persistence)
             * @param {User|null} user
             */
            setCurrentUser: (user) => {
              set({ currentUser: user });
              if (user) {
                SessionManager.save(user);
              } else {
                SessionManager.clear();
              }
            },
            
            /**
             * Toggle sidebar open/closed
             * @param {boolean} isOpen
             */
            setSidebarOpen: (isOpen) => {
              set({ isSidebarOpen: isOpen });
            },
            
            /**
             * Add a new account
             * @param {Omit<Account, 'id'>} account
             */
            addAccount: (account) => {
              const newAccount = {
                ...account,
                id: `acc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
              };
              
              set((state) => ({
                accounts: [...state.accounts, newAccount]
              }));
            },
            
            /**
             * Remove account by ID
             * @param {string} id
             */
            removeAccount: (id) => {
              set((state) => ({
                accounts: state.accounts.filter(a => a.id !== id)
              }));
            },
            
            /**
             * Clear all transactions (used on logout)
             */
            clearTransactions: () => {
              set({ transactions: [] });
            }
          }));
      
      // ============================================================================
      // FIREBASE SYNC HOOK (REALTIME DATABASE)
      // ============================================================================
      
      /**
       * Custom hook for Firebase Realtime Database authentication and synchronization
       * @returns {Object} Auth state and sync functions
       */
      const useFirebaseSync = () => {
        const [isInitialized, setIsInitialized] = useState(false);
        const [isSyncing, setIsSyncing] = useState(false);
        const [syncError, setSyncError] = useState(null);
        const syncedTransactionIds = useRef(new Set());
        const isInitializedRef = useRef(false);
        const hasAttemptedAutoLogin = useRef(false);
        
        const { 
          currentUser, 
          setCurrentUser, 
          transactions, 
          addTransaction,
          removeTransaction,
          updateTransaction,
          clearTransactions
        } = useAppStore();
        
        // ========== MANUAL AUTHENTICATION ==========
        
        /**
         * Sign in with ID and password (manual authentication)
         * @param {string} userId - User ID (marcelino, luiza, or casal)
         * @param {string} password - User password
         * @param {string} profile - Profile type for 'casal': 'admin' or 'usuario_c'
         */
        const signIn = async (userId, password, profile = null) => {
          try {
            setSyncError(null);
            setIsSyncing(true);
            
            // Get user data from database
            const userRef = ref(database, `usuarios_app/${userId}`);
            const snapshot = await get(userRef);
            
            if (!snapshot.exists()) {
              throw new Error('Usu√°rio n√£o encontrado');
            }
            
            const userData = snapshot.val();
            
            // Verify password
            if (userData.senha !== password) {
              throw new Error('Senha incorreta');
            }
            
            // Define user profile based on ID
            let userName = '';
            let userType = '';
            let storageId = userId; // ID for database storage
            
            if (userId === 'marcelino') {
              userName = 'Marcelino';
              userType = 'user_a';
            } else if (userId === 'luiza') {
              userName = 'Luiza';
              userType = 'user_b';
            } else if (userId === 'casal') {
              // Casal can be admin OR usuario_c
              if (profile === 'admin') {
                userName = 'Casal (Admin)';
                userType = 'admin';
                storageId = 'casal'; // Admin doesn't have own storage
              } else {
                userName = 'Casal';
                userType = 'usuario_c';
                storageId = 'casalusuario'; // Own storage for joint finances
              }
            } else {
              userName = userId;
              userType = 'unknown';
            }
            
            const user = {
              id: storageId,
              email: userData.email || `${userId}@local`,
              name: userName,
              type: userType
            };
            
            // Load transactions from database FIRST
            await loadTransactionsFromDatabase(storageId, userType);
            
            // Mark as initialized FIRST (before setting user to trigger useEffect)
            isInitializedRef.current = true;
            
            // Set user (this also saves to localStorage and triggers useEffect)
            setCurrentUser(user);
            setIsInitialized(true);
            
            console.log('‚úÖ Logged in:', userName, '| User ID:', storageId, '| Type:', userType);
            console.log('‚úÖ System initialized (ref):', isInitializedRef.current);
            
            return user;
          } catch (error) {
            console.error('Login error:', error);
            setSyncError(`Erro ao fazer login: ${error.message}`);
            throw error;
          } finally {
            setIsSyncing(false);
          }
        };
        
        /**
         * Sign out
         */
        const signOut = async () => {
          try {
            clearTransactions();
            syncedTransactionIds.current.clear();
            isInitializedRef.current = false;
            hasAttemptedAutoLogin.current = false;
            setCurrentUser(null); // This also clears localStorage
            setIsInitialized(false);
            console.log('‚úÖ Logged out and session cleared');
          } catch (error) {
            console.error('Logout error:', error);
            setSyncError(`Erro ao fazer logout: ${error.message}`);
          }
        };
        
        // ========== REALTIME DATABASE SYNC ==========
        
        /**
         * Load transactions from Realtime Database
         * For admin (casal), loads from both marcelino and luiza
         */
        const loadTransactionsFromDatabase = async (userId, userType) => {
          if (!userId) return;
          
          try {
            setIsSyncing(true);
            setSyncError(null);
            
            // Clear local transactions before loading
            clearTransactions();
            syncedTransactionIds.current.clear();
            
            const allTransactions = [];
            
            // Admin loads from both users
            if (userType === 'admin') {
              console.log('üì• Loading transactions from both users (Admin mode)');
              
              // Load marcelino's transactions
              const marcelinoRef = ref(database, 'transactions/marcelino');
              const marcelinoSnapshot = await get(marcelinoRef);
              if (marcelinoSnapshot.exists()) {
                const data = marcelinoSnapshot.val();
                Object.entries(data).forEach(([key, value]) => {
                  allTransactions.push({
                    ...value,
                    id: key,
                    ownerId: value.ownerId || 'marcelino'
                  });
                });
              }
              
              // Load luiza's transactions
              const luizaRef = ref(database, 'transactions/luiza');
              const luizaSnapshot = await get(luizaRef);
              if (luizaSnapshot.exists()) {
                const data = luizaSnapshot.val();
                Object.entries(data).forEach(([key, value]) => {
                  allTransactions.push({
                    ...value,
                    id: key,
                    ownerId: value.ownerId || 'luiza'
                  });
                });
              }
              
              // Load casalusuario's transactions (joint account)
              const casalUsuarioRef = ref(database, 'transactions/casalusuario');
              const casalUsuarioSnapshot = await get(casalUsuarioRef);
              if (casalUsuarioSnapshot.exists()) {
                const data = casalUsuarioSnapshot.val();
                Object.entries(data).forEach(([key, value]) => {
                  allTransactions.push({
                    ...value,
                    id: key,
                    ownerId: value.ownerId || 'casalusuario'
                  });
                });
              }
              
              console.log(`üì• Loaded ${allTransactions.length} transactions from all users`);
            } else {
              // Regular user loads only their own
              const transactionsRef = ref(database, `transactions/${userId}`);
              const snapshot = await get(transactionsRef);
              
              if (snapshot.exists()) {
                const data = snapshot.val();
                Object.entries(data).forEach(([key, value]) => {
                  allTransactions.push({
                    ...value,
                    id: key,
                    ownerId: value.ownerId || userId
                  });
                });
                
                console.log(`üì• Loaded ${allTransactions.length} transactions for ${userId}`);
              } else {
                console.log('üì• No transactions found in database');
              }
            }
            
            // Add all transactions to store and mark as synced
            allTransactions.forEach((transaction) => {
              addTransaction(transaction);
              syncedTransactionIds.current.add(transaction.id);
            });
            
            console.log('‚úÖ Transactions loaded from database');
          } catch (error) {
            console.error('Error loading transactions:', error);
            setSyncError(`Erro ao carregar dados: ${error.message}`);
          } finally {
            setIsSyncing(false);
          }
        };
        
        /**
         * Save transaction to Realtime Database
         * Admin saves to the owner's path (marcelino or luiza)
         */
        const saveTransactionToDatabase = async (transaction) => {
          if (!currentUser) {
            console.warn('‚ö†Ô∏è No current user, skipping save');
            return;
          }
          
          try {
            // Determine the storage path based on ownerId
            // Admin transactions are saved under the actual owner (marcelino or luiza)
            const storagePath = currentUser.type === 'admin' 
              ? transaction.ownerId 
              : currentUser.id;
            
            const finalOwnerId = transaction.ownerId || currentUser.id;
            
            const dbPath = `transactions/${storagePath}/${transaction.id}`;
            
            console.log('üíæ Saving transaction:', {
              id: transaction.id,
              path: dbPath,
              userId: currentUser.id,
              ownerId: finalOwnerId,
              userType: currentUser.type,
              description: transaction.description
            });
            
            const transactionRef = ref(database, dbPath);
            const dataToSave = {
              ...transaction,
              userId: currentUser.id,
              ownerId: finalOwnerId,
              updatedAt: new Date().toISOString()
            };
            
            console.log('üì§ Data being sent to Firebase:', dataToSave);
            
            await set(transactionRef, dataToSave);
            
            console.log('‚úÖ Transaction synced successfully to:', dbPath);
          } catch (error) {
            console.error('Error saving transaction:', error);
            setSyncError(`Erro ao salvar: ${error.message}`);
          }
        };
        
        /**
         * Update transaction in Realtime Database
         */
        const updateTransactionInDatabase = async (transactionId, updates, ownerId = null) => {
          if (!currentUser) return;
          
          try {
            const storagePath = currentUser.type === 'admin' && ownerId 
              ? ownerId 
              : currentUser.id;
            
            const transactionRef = ref(database, `transactions/${storagePath}/${transactionId}`);
            await update(transactionRef, {
              ...updates,
              updatedAt: new Date().toISOString()
            });
            
            console.log('‚úÖ Transaction updated in database:', transactionId, 'at', storagePath);
          } catch (error) {
            console.error('Error updating transaction:', error);
            setSyncError(`Erro ao atualizar: ${error.message}`);
            throw error;
          }
        };
        
        /**
         * Delete transaction from Realtime Database
         * Admin deletes from the owner's path (marcelino or luiza)
         */
        const deleteTransactionFromDatabase = async (transactionId, ownerId = null) => {
          if (!currentUser) return;
          
          try {
            // Determine the storage path based on ownerId (for admin) or currentUser.id
            const storagePath = currentUser.type === 'admin' && ownerId 
              ? ownerId 
              : currentUser.id;
            
            const transactionRef = ref(database, `transactions/${storagePath}/${transactionId}`);
            await remove(transactionRef);
            console.log('‚úÖ Transaction deleted from database:', transactionId, 'from', storagePath);
          } catch (error) {
            console.error('Error deleting transaction:', error);
            setSyncError(`Erro ao deletar: ${error.message}`);
          }
        };
        
        // ========== EFFECTS ==========
        
        // Auto-login from saved session
        useEffect(() => {
          if (!currentUser && !hasAttemptedAutoLogin.current) {
            hasAttemptedAutoLogin.current = true;
            const savedUser = SessionManager.load();
            if (savedUser) {
              console.log('üîÑ Restoring session for:', savedUser.name);
              setCurrentUser(savedUser);
              // Load transactions for restored user
              loadTransactionsFromDatabase(savedUser.id, savedUser.type).then(() => {
                isInitializedRef.current = true;
                setIsInitialized(true);
                console.log('‚úÖ Session restored and data loaded');
              });
            }
          }
        }, []);
        
        // Log initialization status
        useEffect(() => {
          console.log('üîß Firebase Sync Status:', {
            currentUser: currentUser?.name || 'None',
            userId: currentUser?.id || 'None',
            isInitialized,
            transactionsCount: transactions.length,
            syncedCount: syncedTransactionIds.current.size
          });
        }, [currentUser, isInitialized, transactions.length]);
        
        // Monitor transaction changes and sync to database immediately
        useEffect(() => {
          const debugInfo = {
            hasUser: !!currentUser,
            userName: currentUser?.name,
            refInitialized: isInitializedRef.current,
            txCount: transactions.length,
            syncedCount: syncedTransactionIds.current.size
          };
          
          console.log('üîç Sync Effect Triggered:', debugInfo);
          
          if (!currentUser) {
            console.warn('‚è∏Ô∏è BLOCKED: No user logged in');
            return;
          }
          
          if (!isInitializedRef.current) {
            console.warn('‚è∏Ô∏è BLOCKED: Not initialized (waiting for data load)');
            return;
          }
          
          console.log('‚úÖ Sync checks passed! Processing', transactions.length, 'transactions...');
          
          // Find new transactions that haven't been synced yet
          let syncedCount = 0;
          transactions.forEach((transaction) => {
            if (!syncedTransactionIds.current.has(transaction.id)) {
              console.log('üÜï NEW TRANSACTION FOUND:', transaction.id, transaction.description);
              syncedTransactionIds.current.add(transaction.id);
              saveTransactionToDatabase(transaction);
              syncedCount++;
            }
          });
          
          if (syncedCount === 0) {
            console.log('‚ÑπÔ∏è No new transactions to sync');
          } else {
            console.log(`üì§ Syncing ${syncedCount} new transaction(s)...`);
          }
        }, [transactions, currentUser]);
        
        // Real-time listener for database changes (DISABLED to prevent loops)
        useEffect(() => {
          if (!currentUser || !isInitialized) return;
          
          console.log('‚ö†Ô∏è Real-time listener DISABLED to prevent sync loops');
          return; // TEMPORARILY DISABLED
          
          const unsubscribeList = [];
          
          if (currentUser.type === 'admin') {
            // Admin: listen to both marcelino and luiza paths
            const marcelinoRef = ref(database, 'transactions/marcelino');
            const luizaRef = ref(database, 'transactions/luiza');
            
            const handleSnapshot = (snapshot, ownerId) => {
              if (snapshot.exists()) {
                const data = snapshot.val();
                const cloudTransactions = Object.entries(data).map(([key, value]) => ({
                  ...value,
                  id: key,
                  ownerId: value.ownerId || ownerId
                }));
                
                // Sync cloud transactions with local store
                cloudTransactions.forEach((cloudTxn) => {
                  const localExists = transactions.some(t => t.id === cloudTxn.id);
                  if (!localExists) {
                    console.log('üì• New transaction from database:', cloudTxn.id, 'owner:', cloudTxn.ownerId);
                    addTransaction(cloudTxn);
                    syncedTransactionIds.current.add(cloudTxn.id);
                  }
                });
              }
            };
            
            const unsubMarcelino = onValue(marcelinoRef, (snapshot) => handleSnapshot(snapshot, 'marcelino'), (error) => {
              console.error('Database listener error (marcelino):', error);
            });
            
            const unsubLuiza = onValue(luizaRef, (snapshot) => handleSnapshot(snapshot, 'luiza'), (error) => {
              console.error('Database listener error (luiza):', error);
            });
            
            // Also listen to casalusuario (joint account)
            const casalUsuarioRef = ref(database, 'transactions/casalusuario');
            const unsubCasalUsuario = onValue(casalUsuarioRef, (snapshot) => handleSnapshot(snapshot, 'casalusuario'), (error) => {
              console.error('Database listener error (casalusuario):', error);
            });
            
            unsubscribeList.push(unsubMarcelino, unsubLuiza, unsubCasalUsuario);
          } else {
            // Regular user: listen only to their own path
            const transactionsRef = ref(database, `transactions/${currentUser.id}`);
            
            const unsubscribe = onValue(transactionsRef, (snapshot) => {
              if (snapshot.exists()) {
                const data = snapshot.val();
                const cloudTransactions = Object.entries(data).map(([key, value]) => ({
                  ...value,
                  id: key,
                  ownerId: value.ownerId || currentUser.id
                }));
                
                // Sync cloud transactions with local store
                cloudTransactions.forEach((cloudTxn) => {
                  const localExists = transactions.some(t => t.id === cloudTxn.id);
                  if (!localExists) {
                    console.log('üì• New transaction from database:', cloudTxn.id);
                    addTransaction(cloudTxn);
                    syncedTransactionIds.current.add(cloudTxn.id);
                  }
                });
              }
            }, (error) => {
              console.error('Database listener error:', error);
            });
            
            unsubscribeList.push(unsubscribe);
          }
          
          return () => {
            unsubscribeList.forEach(unsub => unsub());
          };
        }, [currentUser, isInitialized]);
        
        return {
          currentUser,
          isInitialized,
          isSyncing,
          syncError,
          signIn,
          signOut,
          loadTransactionsFromDatabase,
          saveTransactionToDatabase,
          updateTransactionInDatabase,
          deleteTransactionFromDatabase
        };
      };
      
      // ============================================================================
      // LOGIN MODAL COMPONENT
      // ============================================================================
      
      const LoginModal = ({ isOpen, onClose, canClose = true }) => {
        const { signIn, syncError, isSyncing } = useFirebaseSync();
        const [formData, setFormData] = useState({ userId: 'marcelino', password: '', profile: 'admin' });
        const [error, setError] = useState('');
        
        const handleSubmit = async (e) => {
          e.preventDefault();
          setError('');
          
          if (!formData.userId || !formData.password) {
            setError('Preencha todos os campos');
            return;
          }
          
          try {
            // Pass profile only if userId is 'casal'
            const profile = formData.userId === 'casal' ? formData.profile : null;
            await signIn(formData.userId, formData.password, profile);
            setFormData({ userId: 'marcelino', password: '', profile: 'admin' });
            onClose();
          } catch (err) {
            setError(err.message);
          }
        };
        
        return (
          <Modal 
            isOpen={isOpen} 
            onClose={canClose ? onClose : undefined} 
            title="Acesso ao Sistema" 
            className="max-w-sm"
          >
            <form onSubmit={handleSubmit} className="space-y-4">
              <Select
                label="Usu√°rio"
                value={formData.userId}
                onChange={(e) => setFormData({ ...formData, userId: e.target.value })}
                disabled={isSyncing}
              >
                <option value="marcelino">Marcelino</option>
                <option value="luiza">Luiza</option>
                <option value="casal">Casal</option>
              </Select>
              
              <Input
                label="Senha"
                type="password"
                value={formData.password}
                onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                placeholder="Digite sua senha"
                disabled={isSyncing}
              />
              
              {formData.userId === 'casal' && (
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-neutral-700">
                    Perfil de Acesso
                  </label>
                  <div className="flex flex-col space-y-2">
                    <label className="flex items-center space-x-2 p-3 border border-neutral-200 rounded-lg cursor-pointer hover:bg-neutral-50">
                      <input
                        type="radio"
                        name="profile"
                        value="admin"
                        checked={formData.profile === 'admin'}
                        onChange={(e) => setFormData({ ...formData, profile: e.target.value })}
                        className="w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <div>
                        <span className="block text-sm font-medium text-neutral-900">Admin (Vis√£o Completa)</span>
                        <span className="block text-xs text-neutral-500">Ver e gerenciar finan√ßas de Marcelino e Luiza</span>
                      </div>
                    </label>
                    <label className="flex items-center space-x-2 p-3 border border-neutral-200 rounded-lg cursor-pointer hover:bg-neutral-50">
                      <input
                        type="radio"
                        name="profile"
                        value="usuario_c"
                        checked={formData.profile === 'usuario_c'}
                        onChange={(e) => setFormData({ ...formData, profile: e.target.value })}
                        className="w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <div>
                        <span className="block text-sm font-medium text-neutral-900">Conta Conjunta</span>
                        <span className="block text-xs text-neutral-500">Gerenciar finan√ßas pr√≥prias do casal</span>
                      </div>
                    </label>
                  </div>
                </div>
              )}
              
              {(error || syncError) && (
                <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-sm text-red-800">{error || syncError}</p>
                </div>
              )}
              
              <div className="flex gap-3 pt-2">
                {canClose && (
                  <Button 
                    type="button" 
                    variant="secondary" 
                    onClick={onClose} 
                    className="flex-1"
                    disabled={isSyncing}
                  >
                    Cancelar
                  </Button>
                )}
                <Button 
                  type="submit" 
                  variant="primary" 
                  className={canClose ? "flex-1" : "w-full"}
                  disabled={isSyncing}
                >
                  {isSyncing ? 'Entrando...' : 'Entrar'}
                </Button>
              </div>
            </form>
          </Modal>
        );
      };
      
      // ============================================================================
      // UI COMPONENTS LIBRARY
      // ============================================================================
      
      // ---------- CARD COMPONENTS ----------
      
      /**
       * Card Container Component
       */
      const Card = ({ children, className, ...props }) => {
        return (
          <div
            className={cn(
              "bg-white rounded-lg shadow-sm border border-neutral-200",
              className
            )}
            {...props}
          >
            {children}
          </div>
        );
      };
      
      const CardHeader = ({ children, className, ...props }) => {
        return (
          <div
            className={cn("px-6 py-4 border-b border-neutral-200", className)}
            {...props}
          >
            {children}
          </div>
        );
      };
      
      const CardTitle = ({ children, className, ...props }) => {
        return (
          <h3
            className={cn("text-lg font-semibold text-neutral-900", className)}
            {...props}
          >
            {children}
          </h3>
        );
      };
      
      const CardContent = ({ children, className, ...props }) => {
        return (
          <div className={cn("px-6 py-4", className)} {...props}>
            {children}
          </div>
        );
      };
      
      // ---------- BUTTON COMPONENT ----------
      
      /**
       * Button Component with variants
       * @param {'primary'|'secondary'|'ghost'|'danger'} variant
       */
      const Button = ({ 
        children, 
        className, 
        variant = 'primary', 
        disabled = false,
        type = 'button',
        ...props 
      }) => {
        const variantStyles = {
          primary: "bg-primary-600 hover:bg-primary-700 text-white shadow-sm",
          secondary: "bg-neutral-100 hover:bg-neutral-200 text-neutral-900 border border-neutral-300",
          ghost: "hover:bg-neutral-100 text-neutral-700",
          danger: "bg-red-600 hover:bg-red-700 text-white shadow-sm"
        };
        
        return (
          <button
            type={type}
            disabled={disabled}
            className={cn(
              "px-4 py-2 rounded-lg font-medium transition-all duration-200",
              "focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2",
              "disabled:opacity-50 disabled:cursor-not-allowed",
              variantStyles[variant],
              className
            )}
            {...props}
          >
            {children}
          </button>
        );
      };
      
      // ---------- INPUT COMPONENT ----------
      
      /**
       * Input Component
       */
      const Input = ({ 
        className, 
        label,
        error,
        ...props 
      }) => {
        return (
          <div className="w-full">
            {label && (
              <label className="block text-sm font-medium text-neutral-700 mb-1">
                {label}
              </label>
            )}
            <input
              className={cn(
                "w-full px-3 py-2 rounded-lg border border-neutral-300",
                "bg-white text-neutral-900 placeholder:text-neutral-400",
                "focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",
                "disabled:bg-neutral-50 disabled:cursor-not-allowed",
                "transition-all duration-200",
                error && "border-red-500 focus:ring-red-500",
                className
              )}
              {...props}
            />
            {error && (
              <p className="mt-1 text-sm text-red-600">{error}</p>
            )}
          </div>
        );
      };
      
      // ---------- SELECT COMPONENT ----------
      
      /**
       * Select Component
       */
      const Select = ({ 
        children,
        className, 
        label,
        error,
        ...props 
      }) => {
        return (
          <div className="w-full">
            {label && (
              <label className="block text-sm font-medium text-neutral-700 mb-1">
                {label}
              </label>
            )}
            <select
              className={cn(
                "w-full px-3 py-2 rounded-lg border border-neutral-300",
                "bg-white text-neutral-900",
                "focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent",
                "disabled:bg-neutral-50 disabled:cursor-not-allowed",
                "transition-all duration-200",
                error && "border-red-500 focus:ring-red-500",
                className
              )}
              {...props}
            >
              {children}
            </select>
            {error && (
              <p className="mt-1 text-sm text-red-600">{error}</p>
            )}
          </div>
        );
      };
      
      // ---------- BADGE COMPONENT ----------
      
      /**
       * Badge Component
       * @param {'income'|'expense'|'neutral'|'success'|'warning'|'info'} variant
       */
      const Badge = ({ 
        children, 
        className, 
        variant = 'neutral',
        ...props 
      }) => {
        const variantStyles = {
          income: "bg-primary-100 text-primary-800 border-primary-200",
          expense: "bg-red-100 text-red-800 border-red-200",
          neutral: "bg-neutral-100 text-neutral-800 border-neutral-200",
          success: "bg-green-100 text-green-800 border-green-200",
          warning: "bg-amber-100 text-amber-800 border-amber-200",
          info: "bg-blue-100 text-blue-800 border-blue-200"
        };
        
        return (
          <span
            className={cn(
              "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border",
              variantStyles[variant],
              className
            )}
            {...props}
          >
            {children}
          </span>
        );
      };
      
      // ---------- MODAL COMPONENT ----------
      
      /**
       * Modal Component with backdrop
       */
      const Modal = ({ 
        isOpen, 
        onClose, 
        children, 
        title,
        className 
      }) => {
        useEffect(() => {
          if (isOpen) {
            document.body.style.overflow = 'hidden';
          } else {
            document.body.style.overflow = 'unset';
          }
          
          return () => {
            document.body.style.overflow = 'unset';
          };
        }, [isOpen]);
        
        useEffect(() => {
          const handleEscape = (e) => {
            if (e.key === 'Escape' && isOpen && onClose) {
              onClose();
            }
          };
          
          if (onClose) {
            document.addEventListener('keydown', handleEscape);
            return () => document.removeEventListener('keydown', handleEscape);
          }
        }, [isOpen, onClose]);
        
        if (!isOpen) return null;
        
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div 
              className="absolute inset-0 bg-neutral-900/50 backdrop-blur-sm"
              onClick={onClose ? onClose : undefined}
            />
            
            {/* Modal Content */}
            <div 
              className={cn(
                "relative bg-white rounded-xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto",
                "animate-in fade-in zoom-in duration-200",
                className
              )}
            >
              {title && (
                <div className="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
                  <h2 className="text-xl font-semibold text-neutral-900">
                    {title}
                  </h2>
                  {onClose && (
                    <button
                      onClick={onClose}
                      className="text-neutral-400 hover:text-neutral-600 transition-colors"
                    >
                      <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  )}
                </div>
              )}
              
              <div className="px-6 py-4">
                {children}
              </div>
            </div>
          </div>
        );
      };
      
      // ---------- DELETE CONFIRMATION MODAL ----------
      
      /**
       * Delete Confirmation Modal
       * Handles deletion of single transaction or installment series
       */
      const DeleteConfirmationModal = ({ isOpen, onClose, transaction, onConfirm }) => {
        const { transactions } = useAppStore();
        const [deleteOption, setDeleteOption] = useState('single');
        
        if (!transaction) return null;
        
        // Check if this is part of an installment series
        const isInstallment = transaction.installments && 
                              transaction.installments.current && 
                              transaction.installments.total;
        
        // Find all installments in the series (future only)
        const futureInstallments = isInstallment ? transactions.filter(t => 
          t.description.includes(transaction.description.split('(')[0].trim()) &&
          t.installments &&
          t.installments.total === transaction.installments.total &&
          t.installments.current >= transaction.installments.current &&
          t.id !== transaction.id
        ) : [];
        
        const handleDelete = () => {
          if (isInstallment && deleteOption === 'all') {
            // Delete current and all future installments
            onConfirm(transaction, [...futureInstallments, transaction]);
          } else {
            // Delete only this transaction
            onConfirm(transaction, [transaction]);
          }
          onClose();
        };
        
        return (
          <Modal isOpen={isOpen} onClose={onClose} title="Confirmar Exclus√£o" className="max-w-md">
            <div className="space-y-4">
              <p className="text-sm text-neutral-600">
                Tem certeza que deseja excluir esta transa√ß√£o?
              </p>
              
              <div className="p-3 bg-neutral-50 rounded-lg">
                <p className="font-medium text-neutral-900">{transaction.description}</p>
                <p className="text-sm text-neutral-600 mt-1">
                  Valor: {formatCurrency(transaction.amount)}
                </p>
                {isInstallment && (
                  <p className="text-xs text-neutral-500 mt-1">
                    Parcela {transaction.installments.current} de {transaction.installments.total}
                  </p>
                )}
              </div>
              
              {isInstallment && futureInstallments.length > 0 && (
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-neutral-700">
                    O que deseja excluir?
                  </label>
                  <div className="space-y-2">
                    <label className="flex items-start space-x-2 p-3 border border-neutral-200 rounded-lg cursor-pointer hover:bg-neutral-50">
                      <input
                        type="radio"
                        value="single"
                        checked={deleteOption === 'single'}
                        onChange={(e) => setDeleteOption(e.target.value)}
                        className="mt-0.5 w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <div className="flex-1">
                        <span className="block text-sm font-medium text-neutral-900">Apenas esta parcela</span>
                        <span className="block text-xs text-neutral-500">Mant√©m as demais parcelas</span>
                      </div>
                    </label>
                    <label className="flex items-start space-x-2 p-3 border border-neutral-200 rounded-lg cursor-pointer hover:bg-neutral-50">
                      <input
                        type="radio"
                        value="all"
                        checked={deleteOption === 'all'}
                        onChange={(e) => setDeleteOption(e.target.value)}
                        className="mt-0.5 w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <div className="flex-1">
                        <span className="block text-sm font-medium text-neutral-900">Esta e todas as pr√≥ximas</span>
                        <span className="block text-xs text-neutral-500">
                          Exclui {futureInstallments.length + 1} parcela(s)
                        </span>
                      </div>
                    </label>
                  </div>
                </div>
              )}
              
              <div className="flex gap-3 pt-2">
                <Button 
                  type="button" 
                  variant="secondary" 
                  onClick={onClose}
                  className="flex-1"
                >
                  Cancelar
                </Button>
                <Button 
                  type="button" 
                  variant="primary"
                  onClick={handleDelete}
                  className="flex-1 bg-red-600 hover:bg-red-700"
                >
                  Excluir
                </Button>
              </div>
            </div>
          </Modal>
        );
      };
      
      // ---------- TRANSACTION FORM COMPONENT ----------
      
      /**
       * Transaction Form Component
       * Modal form for creating new transactions or editing existing ones
       * @param {object} transaction - Transaction to edit (null for new transaction)
       */
      const TransactionForm = ({ isOpen, onClose, transaction = null }) => {
        const { addTransaction, updateTransaction } = useAppStore();
        const { currentUser, updateTransactionInDatabase } = useFirebaseSync();
        
        const isEditMode = !!transaction;
        
        // Initialize ownerId based on current user
        const getDefaultOwnerId = () => {
          if (!currentUser) return 'marcelino';
          if (currentUser.type === 'admin') return 'marcelino'; // Admin can choose, defaults to marcelino
          // For regular users (marcelino, luiza, casalusuario), use their ID
          return currentUser.id;
        };
        
        const [formData, setFormData] = useState({
          description: '',
          amount: '',
          date: new Date().toISOString().split('T')[0],
          category: '',
          type: 'expense',
          paymentMethod: 'debit',
          isInstallment: false,
          installmentsCount: 1,
          cardClosingDay: 5,
          ownerId: getDefaultOwnerId()
        });
        
        // Load transaction data when in edit mode or reset when creating new
        useEffect(() => {
          if (isOpen) {
            if (transaction) {
              // Edit mode: load transaction data
              setFormData({
                description: transaction.description || '',
                amount: transaction.amount?.toString() || '',
                date: transaction.date ? new Date(transaction.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                category: transaction.category || '',
                type: transaction.type || 'expense',
                paymentMethod: transaction.paymentMethod || 'debit',
                isInstallment: false,
                installmentsCount: 1,
                cardClosingDay: 5,
                ownerId: transaction.ownerId || getDefaultOwnerId()
              });
            } else {
              // New mode: reset form with current user's ownerId
              const defaultOwnerId = currentUser 
                ? (currentUser.type === 'admin' ? 'marcelino' : currentUser.id)
                : 'marcelino';
              
              setFormData({
                description: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                category: '',
                type: 'expense',
                paymentMethod: 'debit',
                isInstallment: false,
                installmentsCount: 1,
                cardClosingDay: 5,
                ownerId: defaultOwnerId
              });
              
              console.log('üìù Form reset for new transaction, ownerId:', defaultOwnerId);
            }
            setErrors({});
          }
        }, [transaction, isOpen, currentUser]);
        
        // Update ownerId when currentUser changes (only for new transactions)
        useEffect(() => {
          if (!isEditMode && currentUser) {
            const newOwnerId = currentUser.type === 'admin' ? 'marcelino' : currentUser.id;
            if (formData.ownerId !== newOwnerId) {
              setFormData(prev => ({
                ...prev,
                ownerId: newOwnerId
              }));
              console.log('üîÑ Updated ownerId based on currentUser:', newOwnerId);
            }
          }
        }, [currentUser, isEditMode]);
        
        const [errors, setErrors] = useState({});
        
        const categories = [
          'Alimenta√ß√£o',
          'Transporte',
          'Sa√∫de',
          'Educa√ß√£o',
          'Lazer',
          'Moradia',
          'Vestu√°rio',
          'Investimentos',
          'Outros'
        ];
        
        const handleChange = (field, value) => {
          setFormData(prev => ({ ...prev, [field]: value }));
          if (errors[field]) {
            setErrors(prev => ({ ...prev, [field]: null }));
          }
        };
        
        const validateForm = () => {
          const newErrors = {};
          
          if (!formData.description.trim()) {
            newErrors.description = 'Descri√ß√£o √© obrigat√≥ria';
          }
          
          const amount = parseFloat(formData.amount);
          if (!formData.amount || isNaN(amount) || amount <= 0) {
            newErrors.amount = 'Valor deve ser maior que zero';
          }
          
          if (!formData.date) {
            newErrors.date = 'Data √© obrigat√≥ria';
          }
          
          if (formData.isInstallment) {
            const installments = parseInt(formData.installmentsCount);
            if (!installments || installments < 2 || installments > 48) {
              newErrors.installmentsCount = 'Parcelas devem estar entre 2 e 48';
            }
            
            const closingDay = parseInt(formData.cardClosingDay);
            if (!closingDay || closingDay < 1 || closingDay > 31) {
              newErrors.cardClosingDay = 'Dia de fechamento inv√°lido';
            }
          }
          
          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };
        
        const handleSubmit = async (e) => {
          e.preventDefault();
          
          if (!validateForm()) {
            return;
          }
          
          const amount = parseFloat(formData.amount);
          const userId = currentUser?.id || 'default-user';
          const ownerId = formData.ownerId || currentUser?.id || 'marcelino';
          
          console.log('üîç Form Submit Debug:', {
            currentUser: currentUser?.name,
            currentUserId: currentUser?.id,
            currentUserType: currentUser?.type,
            formOwnerId: formData.ownerId,
            finalOwnerId: ownerId,
            finalUserId: userId
          });
          
          if (isEditMode) {
            // Update existing transaction
            console.log('‚úèÔ∏è Updating transaction:', transaction.id);
            
            const updates = {
              description: formData.description,
              amount,
              type: formData.type,
              date: new Date(formData.date).toISOString(),
              category: formData.category,
              paymentMethod: formData.paymentMethod
            };
            
            // Update in local store
            updateTransaction(transaction.id, updates);
            
            // Update in Firebase
            try {
              await updateTransactionInDatabase(transaction.id, updates, transaction.ownerId);
            } catch (error) {
              console.error('Failed to update in database:', error);
            }
            
            onClose();
            return;
          }
          
          // Create new transaction
          console.log('üìù Creating transaction:', { userId, ownerId, currentUser: currentUser?.type });
          
          if (formData.isInstallment && formData.paymentMethod === 'credit') {
            // Generate installment transactions
            const installments = calculateInstallments(
              amount,
              parseInt(formData.installmentsCount),
              formData.date,
              parseInt(formData.cardClosingDay)
            );
            
            // Add all installment transactions
            installments.forEach((inst) => {
              addTransaction({
                description: `${formData.description} (${inst.installment.current}/${inst.installment.total})`,
                amount: inst.amount,
                type: formData.type,
                date: inst.dueDate,
                category: formData.category,
                paymentMethod: formData.paymentMethod,
                installments: inst.installment,
                userId,
                ownerId
              });
            });
          } else {
            // Add single transaction
            addTransaction({
              description: formData.description,
              amount,
              type: formData.type,
              date: new Date(formData.date).toISOString(),
              category: formData.category,
              paymentMethod: formData.paymentMethod,
              installments: null,
              userId,
              ownerId
            });
          }
          
          // Reset form and close
          setFormData({
            description: '',
            amount: '',
            date: new Date().toISOString().split('T')[0],
            category: '',
            type: 'expense',
            paymentMethod: 'debit',
            isInstallment: false,
            installmentsCount: 1,
            cardClosingDay: 5,
            ownerId: getDefaultOwnerId()
          });
          setErrors({});
          onClose();
        };
        
        return (
          <Modal isOpen={isOpen} onClose={onClose} title={isEditMode ? "Editar Transa√ß√£o" : "Nova Transa√ß√£o"} className="max-w-lg">
            <form onSubmit={handleSubmit} className="space-y-4">
              <Input
                label="Descri√ß√£o"
                value={formData.description}
                onChange={(e) => handleChange('description', e.target.value)}
                error={errors.description}
                placeholder="Ex: Compra no supermercado"
              />
              
              <Input
                label="Valor (R$)"
                type="number"
                step="0.01"
                min="0"
                value={formData.amount}
                onChange={(e) => handleChange('amount', e.target.value)}
                error={errors.amount}
                placeholder="0.00"
              />
              
              <Input
                label="Data"
                type="date"
                value={formData.date}
                onChange={(e) => handleChange('date', e.target.value)}
                error={errors.date}
              />
              
              <Select
                label="Categoria"
                value={formData.category}
                onChange={(e) => handleChange('category', e.target.value)}
              >
                <option value="">Selecione uma categoria</option>
                {categories.map((cat) => (
                  <option key={cat} value={cat}>{cat}</option>
                ))}
              </Select>
              
              <Select
                label="Tipo"
                value={formData.type}
                onChange={(e) => handleChange('type', e.target.value)}
              >
                <option value="expense">Despesa</option>
                <option value="income">Receita</option>
              </Select>
              
              <Select
                label="Forma de Pagamento"
                value={formData.paymentMethod}
                onChange={(e) => handleChange('paymentMethod', e.target.value)}
              >
                <option value="debit">D√©bito</option>
                <option value="credit">Cr√©dito</option>
              </Select>
              
              {currentUser?.type === 'admin' && (
                <div className="space-y-2">
                  <label className="block text-sm font-medium text-neutral-700">
                    Quem pagou?
                  </label>
                  <div className="flex flex-wrap gap-3">
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="ownerId"
                        value="marcelino"
                        checked={formData.ownerId === 'marcelino'}
                        onChange={(e) => handleChange('ownerId', e.target.value)}
                        className="w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <span className="text-sm text-neutral-700">Marcelino</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="ownerId"
                        value="luiza"
                        checked={formData.ownerId === 'luiza'}
                        onChange={(e) => handleChange('ownerId', e.target.value)}
                        className="w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <span className="text-sm text-neutral-700">Luiza</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input
                        type="radio"
                        name="ownerId"
                        value="casalusuario"
                        checked={formData.ownerId === 'casalusuario'}
                        onChange={(e) => handleChange('ownerId', e.target.value)}
                        className="w-4 h-4 text-primary-600 border-neutral-300 focus:ring-primary-500"
                      />
                      <span className="text-sm text-neutral-700">Conta Conjunta</span>
                    </label>
                  </div>
                </div>
              )}
              
              {formData.paymentMethod === 'credit' && (
                <div className="space-y-4">
                  <label className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      checked={formData.isInstallment}
                      onChange={(e) => handleChange('isInstallment', e.target.checked)}
                      className="w-4 h-4 text-primary-600 border-neutral-300 rounded focus:ring-primary-500"
                    />
                    <span className="text-sm font-medium text-neutral-700">Parcelado?</span>
                  </label>
                  
                  {formData.isInstallment && (
                    <>
                      <Input
                        label="Quantidade de Parcelas"
                        type="number"
                        min="2"
                        max="48"
                        value={formData.installmentsCount}
                        onChange={(e) => handleChange('installmentsCount', e.target.value)}
                        error={errors.installmentsCount}
                      />
                      
                      <Input
                        label="Dia de Fechamento do Cart√£o"
                        type="number"
                        min="1"
                        max="31"
                        value={formData.cardClosingDay}
                        onChange={(e) => handleChange('cardClosingDay', e.target.value)}
                        error={errors.cardClosingDay}
                        placeholder="Ex: 5"
                      />
                      
                      {formData.amount && formData.installmentsCount > 1 && (
                        <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                          <p className="text-sm text-blue-800">
                            <strong>Simula√ß√£o:</strong> {formData.installmentsCount}x de aproximadamente{' '}
                            {formatCurrency(parseFloat(formData.amount) / parseInt(formData.installmentsCount))}
                          </p>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
              
              <div className="flex gap-3 pt-4">
                <Button type="button" variant="secondary" onClick={onClose} className="flex-1">
                  Cancelar
                </Button>
                <Button type="submit" variant="primary" className="flex-1">
                  Salvar
                </Button>
              </div>
            </form>
          </Modal>
        );
      };
      
      // ============================================================================
      // AUTH BUTTON COMPONENT
      // ============================================================================
      
      const AuthButton = () => {
        const { currentUser, signOut, isSyncing } = useFirebaseSync();
        const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
        
        if (isSyncing) {
          return (
            <div className="flex items-center gap-2 px-3 py-2 text-sm text-neutral-600">
              <div className="animate-spin h-4 w-4 border-2 border-primary-600 border-t-transparent rounded-full" />
              <span>Sincronizando...</span>
            </div>
          );
        }
        
        if (currentUser) {
          return (
            <div className="flex items-center gap-3">
              <div className="text-right hidden sm:block">
                <p className="text-xs text-neutral-500">Logado como</p>
                <p className="text-sm font-medium text-neutral-900">{currentUser.name}</p>
              </div>
              <Button variant="secondary" onClick={signOut} className="text-sm">
                Sair
              </Button>
            </div>
          );
        }
        
        return (
          <>
            <Button onClick={() => setIsLoginModalOpen(true)} className="text-sm">
              Login
            </Button>
            <LoginModal isOpen={isLoginModalOpen} onClose={() => setIsLoginModalOpen(false)} />
          </>
        );
      };
      
      // ============================================================================
      // LAYOUT COMPONENT
      // ============================================================================
      
      const Layout = ({ children }) => {
        const { isSidebarOpen, setSidebarOpen } = useAppStore();
        const navItems = [
          { label: 'Dashboard', to: '/', icon: LayoutDashboard },
          { label: 'Calend√°rio', to: '/calendar', icon: Calendar },
          { label: 'Transa√ß√µes', to: '/transactions', icon: ListOrdered },
          { label: 'Cart√µes', to: '/cards', icon: CreditCard },
          { label: 'Importa√ß√£o', to: '/import', icon: UploadCloud },
          { label: 'Configura√ß√µes', to: '/settings', icon: SettingsIcon }
        ];
        
        const closeSidebar = () => setSidebarOpen(false);
        const openSidebar = () => setSidebarOpen(true);
        
        return (
          <div className="min-h-screen bg-neutral-100 flex">
            <div
              className={cn(
                "lg:hidden fixed inset-0 bg-neutral-900/40 backdrop-blur-sm transition-opacity",
                isSidebarOpen ? "opacity-100 pointer-events-auto" : "opacity-0 pointer-events-none"
              )}
              onClick={closeSidebar}
            />
            
            <aside
              className={cn(
                "fixed inset-y-0 left-0 w-64 bg-white border-r border-neutral-200 flex flex-col z-50",
                "transition-transform duration-200 ease-in-out transform",
                isSidebarOpen ? "translate-x-0" : "-translate-x-full",
                "lg:static lg:translate-x-0"
              )}
            >
              <div className="px-6 py-5 border-b border-neutral-200 flex items-center justify-between">
                <div>
                  <p className="text-xs uppercase tracking-wide text-neutral-500">Sistema</p>
                  <p className="text-base font-semibold text-neutral-900">Financeiro Pessoal</p>
                </div>
                <button
                  className="lg:hidden text-neutral-500 hover:text-neutral-900"
                  onClick={closeSidebar}
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
                {navItems.map(({ label, to, icon: Icon }) => (
                  <NavLink
                    key={to}
                    to={to}
                    className={({ isActive }) => cn(
                      "flex items-center px-3 py-2 text-sm font-medium rounded-lg border",
                      "text-neutral-600 border-transparent hover:bg-neutral-50",
                      isActive && "text-primary-700 bg-primary-50 border-primary-200"
                    )}
                    end={to === '/'}
                    onClick={closeSidebar}
                  >
                    <Icon className="w-5 h-5" />
                    <span className="ml-3">{label}</span>
                  </NavLink>
                ))}
              </nav>
              
              <div className="px-6 py-4 border-t border-neutral-200">
                <p className="text-xs text-neutral-500">Ambiente Seguro</p>
                <p className="text-sm font-medium text-neutral-900">Vers√£o 0.1</p>
              </div>
            </aside>
            
            <div className="flex-1 lg:ml-64 flex flex-col min-h-screen">
              <header className="bg-white border-b border-neutral-200 px-4 lg:px-8 py-4 flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <button
                    className="lg:hidden p-2 rounded-lg border border-neutral-200"
                    onClick={openSidebar}
                  >
                    <Menu className="w-5 h-5 text-neutral-700" />
                  </button>
                  <div>
                    <p className="text-xs text-neutral-500 uppercase tracking-wide">Painel Principal</p>
                    <h1 className="text-lg font-semibold text-neutral-900">Sistema Financeiro</h1>
                  </div>
                </div>
                <AuthButton />
              </header>
              
              <main className="flex-1 p-4 lg:p-8">{children}</main>
            </div>
          </div>
        );
      };
      
      // ============================================================================
      // DASHBOARD PAGE
      // ============================================================================
      
      const Dashboard = () => {
        const { transactions, globalFilter } = useAppStore();
        const { currentUser, deleteTransactionFromDatabase } = useFirebaseSync();
        const [isFormOpen, setIsFormOpen] = useState(false);
        const [editingTransaction, setEditingTransaction] = useState(null);
        const [deletingTransaction, setDeletingTransaction] = useState(null);
        const now = useMemo(() => new Date(), []);
        const activePeriod = useMemo(() => ({
          month: globalFilter.month ?? now.getMonth() + 1,
          year: globalFilter.year ?? now.getFullYear()
        }), [globalFilter, now]);
        
        const filteredTransactions = useMemo(() => {
          return transactions.filter((transaction) =>
            isSameMonthYear(transaction.date, activePeriod.month, activePeriod.year)
          );
        }, [transactions, activePeriod]);
        
        const summary = useMemo(() => {
          return filteredTransactions.reduce(
            (acc, transaction) => {
              if (transaction.type === 'income') {
                acc.income += transaction.amount;
              }
              if (transaction.type === 'expense') {
                acc.expense += transaction.amount;
              }
              return acc;
            },
            { income: 0, expense: 0 }
          );
        }, [filteredTransactions]);
        
        const balance = summary.income - summary.expense;
        
        const lastTransactions = useMemo(() => {
          return [...filteredTransactions]
            .sort((a, b) => {
              const dateA = parseToDate(a.date)?.getTime() || 0;
              const dateB = parseToDate(b.date)?.getTime() || 0;
              return dateB - dateA;
            })
            .slice(0, 5);
        }, [filteredTransactions]);
        
        const handleDeleteConfirm = async (transaction, transactionsToDelete) => {
          for (const txn of transactionsToDelete) {
            await deleteTransactionFromDatabase(txn.id, txn.ownerId);
          }
          setDeletingTransaction(null);
        };
        
        const summaryCards = [
          {
            title: 'Receitas',
            value: formatCurrency(summary.income),
            icon: ArrowUpCircle,
            accent: 'text-green-700 bg-green-100',
            emoji: '‚ÜóÔ∏è'
          },
          {
            title: 'Despesas',
            value: formatCurrency(summary.expense),
            icon: ArrowDownCircle,
            accent: 'text-red-700 bg-red-100',
            emoji: '‚ÜòÔ∏è'
          },
          {
            title: 'Saldo',
            value: formatCurrency(balance),
            icon: Wallet,
            accent: balance >= 0 ? 'text-blue-700 bg-blue-100' : 'text-orange-700 bg-orange-100',
            emoji: balance >= 0 ? 'üí∞' : '‚ö†Ô∏è'
          }
        ];
        
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold text-neutral-900">Dashboard</h2>
                <p className="text-sm text-neutral-600">Vis√£o geral das suas finan√ßas</p>
              </div>
              <Button onClick={() => setIsFormOpen(true)}>
                + Nova Transa√ß√£o
              </Button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {summaryCards.map(({ title, value, icon: Icon, accent }) => (
                <Card key={title}>
                  <CardContent className="flex items-center justify-between">
                    <div>
                      <p className="text-sm text-neutral-500">{title}</p>
                      <p className="text-2xl font-semibold text-neutral-900 mt-2">{value}</p>
                    </div>
                    <span className={cn('p-3 rounded-full', accent)}>
                      <Icon className="w-6 h-6" />
                    </span>
                  </CardContent>
                </Card>
              ))}
            </div>
            
            <Card>
              <CardHeader>
                <CardTitle>√öltimas transa√ß√µes</CardTitle>
                <p className="text-sm text-neutral-500">
                  Per√≠odo: {String(activePeriod.month).padStart(2, '0')}/{activePeriod.year}
                </p>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="text-left text-neutral-500">
                        <th className="py-2">Descri√ß√£o</th>
                        <th className="py-2">Categoria</th>
                        <th className="py-2">Data</th>
                        {currentUser?.type === 'admin' && <th className="py-2">Quem</th>}
                        <th className="py-2 text-right">Valor</th>
                        <th className="py-2 text-right">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-100">
                      {lastTransactions.length === 0 && (
                        <tr>
                          <td colSpan={currentUser?.type === 'admin' ? "6" : "5"} className="py-6 text-center text-neutral-500">
                            Nenhuma transa√ß√£o no per√≠odo selecionado.
                          </td>
                        </tr>
                      )}
                      {lastTransactions.map((transaction) => (
                        <tr 
                          key={transaction.id} 
                          className={cn(
                            "hover:opacity-90 transition-opacity",
                            transaction.type === 'income' ? 'bg-green-50' : 'bg-red-50'
                          )}
                        >
                          <td className="py-3 font-medium text-neutral-900">
                            <span className="flex items-center gap-2">
                              <span className={cn(
                                "text-lg",
                                transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                              )}>
                                {transaction.type === 'income' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'}
                              </span>
                              {transaction.description}
                            </span>
                          </td>
                          <td className="py-3">
                            <Badge variant={transaction.type === 'income' ? 'income' : 'expense'}>
                              {transaction.category || 'Geral'}
                            </Badge>
                          </td>
                          <td className="py-3 text-neutral-600">{formatDateLabel(transaction.date)}</td>
                          {currentUser?.type === 'admin' && (
                            <td className="py-3">
                              <Badge variant="info">
                                {getOwnerName(transaction.ownerId)}
                              </Badge>
                            </td>
                          )}
                          <td
                            className={cn(
                              'py-3 text-right font-semibold',
                              transaction.type === 'income' ? 'text-primary-600' : 'text-red-600'
                            )}
                          >
                            {transaction.type === 'income' ? '+' : '-'}
                            {formatCurrency(transaction.amount)}
                          </td>
                          <td className="py-3 text-right">
                            <div className="flex items-center justify-end gap-1">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setEditingTransaction(transaction)}
                                className="text-blue-600 hover:text-blue-700"
                              >
                                ‚úèÔ∏è
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setDeletingTransaction(transaction)}
                                className="text-red-600 hover:text-red-700"
                              >
                                üóëÔ∏è
                              </Button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
            
            <TransactionForm 
              isOpen={isFormOpen || !!editingTransaction} 
              onClose={() => {
                setIsFormOpen(false);
                setEditingTransaction(null);
              }} 
              transaction={editingTransaction}
            />
            
            <DeleteConfirmationModal
              isOpen={!!deletingTransaction}
              onClose={() => setDeletingTransaction(null)}
              transaction={deletingTransaction}
              onConfirm={handleDeleteConfirm}
            />
          </div>
        );
      };
      
      // ============================================================================
      // TRANSACTIONS PAGE
      // ============================================================================
      
      const TransactionsPage = () => {
        const { transactions, globalFilter, setGlobalFilter } = useAppStore();
        const { currentUser, deleteTransactionFromDatabase } = useFirebaseSync();
        const [editingTransaction, setEditingTransaction] = useState(null);
        const [deletingTransaction, setDeletingTransaction] = useState(null);
        
        const monthOptions = [
          'Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'
        ];
        
        const years = useMemo(() => {
          const set = new Set();
          const now = new Date();
          set.add(now.getFullYear());
          transactions.forEach((transaction) => {
            const date = parseToDate(transaction.date);
            if (date) {
              set.add(date.getFullYear());
            }
          });
          return Array.from(set).sort();
        }, [transactions]);
        
        const filtered = useMemo(() => {
          return transactions.filter((transaction) => {
            const date = parseToDate(transaction.date);
            if (!date) return false;
            const monthMatch = globalFilter.month ? date.getMonth() + 1 === globalFilter.month : true;
            const yearMatch = globalFilter.year ? date.getFullYear() === globalFilter.year : true;
            return monthMatch && yearMatch;
          });
        }, [transactions, globalFilter]);
        
        const handleDeleteConfirm = async (transaction, transactionsToDelete) => {
          for (const txn of transactionsToDelete) {
            await deleteTransactionFromDatabase(txn.id, txn.ownerId);
          }
          setDeletingTransaction(null);
        };
        
        const handleMonthChange = (event) => {
          const value = event.target.value;
          setGlobalFilter({ month: value ? Number(value) : null });
        };
        
        const handleYearChange = (event) => {
          const value = event.target.value;
          setGlobalFilter({ year: value ? Number(value) : null });
        };
        
        return (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Filtros</CardTitle>
              </CardHeader>
              <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Select label="M√™s" value={globalFilter.month ?? ''} onChange={handleMonthChange}>
                  <option value="">Todos</option>
                  {monthOptions.map((label, index) => (
                    <option key={label} value={index + 1}>{label}</option>
                  ))}
                </Select>
                <Select label="Ano" value={globalFilter.year ?? ''} onChange={handleYearChange}>
                  <option value="">Todos</option>
                  {years.map((year) => (
                    <option key={year} value={year}>{year}</option>
                  ))}
                </Select>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Extrato Completo</CardTitle>
                <p className="text-sm text-neutral-500">{filtered.length} transa√ß√µes encontradas</p>
              </CardHeader>
              <CardContent>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="text-left text-neutral-500">
                        <th className="py-2">Data</th>
                        <th className="py-2">Descri√ß√£o</th>
                        <th className="py-2">Categoria</th>
                        <th className="py-2">Pagamento</th>
                        {currentUser?.type === 'admin' && <th className="py-2">Quem</th>}
                        <th className="py-2 text-right">Valor</th>
                        <th className="py-2 text-right">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-neutral-100">
                      {filtered.length === 0 && (
                        <tr>
                          <td colSpan={currentUser?.type === 'admin' ? "7" : "6"} className="py-6 text-center text-neutral-500">
                            Nenhuma transa√ß√£o encontrada para o filtro atual.
                          </td>
                        </tr>
                      )}
                      {filtered.map((transaction) => (
                        <tr 
                          key={transaction.id} 
                          className={cn(
                            "hover:opacity-90 transition-opacity",
                            transaction.type === 'income' ? 'bg-green-50' : 'bg-red-50'
                          )}
                        >
                          <td className="py-3 text-neutral-600">{formatDateLabel(transaction.date)}</td>
                          <td className="py-3 font-medium text-neutral-900">
                            <span className="flex items-center gap-2">
                              <span className={cn(
                                "text-lg",
                                transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                              )}>
                                {transaction.type === 'income' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'}
                              </span>
                              {transaction.description}
                            </span>
                          </td>
                          <td className="py-3">
                            <Badge variant={transaction.type === 'income' ? 'income' : 'expense'}>
                              {transaction.category || 'Geral'}
                            </Badge>
                          </td>
                          <td className="py-3 text-neutral-600 capitalize">{transaction.paymentMethod || '‚Äî'}</td>
                          {currentUser?.type === 'admin' && (
                            <td className="py-3">
                              <Badge variant="info">
                                {getOwnerName(transaction.ownerId)}
                              </Badge>
                            </td>
                          )}
                          <td
                            className={cn(
                              'py-3 text-right font-semibold',
                              transaction.type === 'income' ? 'text-primary-600' : 'text-red-600'
                            )}
                          >
                            {transaction.type === 'income' ? '+' : '-'}
                            {formatCurrency(transaction.amount)}
                          </td>
                          <td className="py-3 text-right">
                            <div className="flex items-center justify-end gap-2">
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setEditingTransaction(transaction)}
                                className="text-blue-600 hover:text-blue-700"
                              >
                                ‚úèÔ∏è Editar
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={() => setDeletingTransaction(transaction)}
                                className="text-red-600 hover:text-red-700"
                              >
                                üóëÔ∏è Excluir
                              </Button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
            
            <TransactionForm 
              isOpen={!!editingTransaction} 
              onClose={() => setEditingTransaction(null)} 
              transaction={editingTransaction}
            />
            
            <DeleteConfirmationModal
              isOpen={!!deletingTransaction}
              onClose={() => setDeletingTransaction(null)}
              transaction={deletingTransaction}
              onConfirm={handleDeleteConfirm}
            />
          </div>
        );
      };
      
      // ============================================================================
      // CALENDAR PAGE
      // ============================================================================
      
      const CalendarPage = () => {
        const { transactions, globalFilter, setGlobalFilter } = useAppStore();
        const { currentUser } = useFirebaseSync();
        const now = new Date();
        const [currentMonth, setCurrentMonth] = useState(globalFilter.month || now.getMonth() + 1);
        const [currentYear, setCurrentYear] = useState(globalFilter.year || now.getFullYear());
        
        const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
        const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1).getDay();
        
        const monthTransactions = useMemo(() => {
          return transactions.filter((t) => {
            const date = parseToDate(t.date);
            return date && date.getMonth() + 1 === currentMonth && date.getFullYear() === currentYear;
          });
        }, [transactions, currentMonth, currentYear]);
        
        const getTransactionsForDay = (day) => {
          return monthTransactions.filter((t) => {
            const date = parseToDate(t.date);
            return date && date.getDate() === day;
          });
        };
        
        const getSummaryForDay = (day) => {
          const dayTxns = getTransactionsForDay(day);
          return dayTxns.reduce((acc, t) => {
            if (t.type === 'income') acc.income += t.amount;
            if (t.type === 'expense') acc.expense += t.amount;
            return acc;
          }, { income: 0, expense: 0 });
        };
        
        const prevMonth = () => {
          if (currentMonth === 1) {
            setCurrentMonth(12);
            setCurrentYear(currentYear - 1);
          } else {
            setCurrentMonth(currentMonth - 1);
          }
        };
        
        const nextMonth = () => {
          if (currentMonth === 12) {
            setCurrentMonth(1);
            setCurrentYear(currentYear + 1);
          } else {
            setCurrentMonth(currentMonth + 1);
          }
        };
        
        const monthName = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'][currentMonth - 1];
        const weekDays = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
        
        return (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <CardTitle>{monthName} {currentYear}</CardTitle>
                  <div className="flex gap-2">
                    <Button variant="secondary" size="sm" onClick={prevMonth}>‚Üê</Button>
                    <Button variant="secondary" size="sm" onClick={nextMonth}>‚Üí</Button>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-7 gap-2">
                  {weekDays.map(day => (
                    <div key={day} className="text-center text-xs font-medium text-neutral-500 py-2">{day}</div>
                  ))}
                  {[...Array(firstDayOfMonth)].map((_, i) => <div key={`empty-${i}`} />)}
                  {[...Array(daysInMonth)].map((_, i) => {
                    const day = i + 1;
                    const summary = getSummaryForDay(day);
                    const dayTxns = getTransactionsForDay(day);
                    const hasTransactions = dayTxns.length > 0;
                    const isToday = day === now.getDate() && currentMonth === now.getMonth() + 1 && currentYear === now.getFullYear();
                    
                    return (
                      <div
                        key={day}
                        className={cn(
                          "border rounded-lg p-2 min-h-24 hover:bg-neutral-50",
                          isToday && "border-primary-500 bg-primary-50/30",
                          !hasTransactions && "bg-neutral-50"
                        )}
                      >
                        <div className="text-sm font-medium text-neutral-900 mb-1">{day}</div>
                        {hasTransactions && (
                          <div className="space-y-1 text-xs">
                            {summary.income > 0 && (
                              <div className="text-primary-600 font-medium">+{formatCurrency(summary.income)}</div>
                            )}
                            {summary.expense > 0 && (
                              <div className="text-red-600 font-medium">-{formatCurrency(summary.expense)}</div>
                            )}
                            <div className="text-neutral-500">{dayTxns.length} transa√ß√£o(√µes)</div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>
        );
      };
      
      // ============================================================================
      // CARDS PAGE (CREDIT CARDS)
      // ============================================================================
      
      const CardsPage = () => {
        const { transactions } = useAppStore();
        const { currentUser } = useFirebaseSync();
        
        const creditCardTransactions = useMemo(() => {
          return transactions.filter(t => t.paymentMethod === 'credit');
        }, [transactions]);
        
        const groupedByMonth = useMemo(() => {
          const groups = {};
          creditCardTransactions.forEach(t => {
            const date = parseToDate(t.date);
            if (!date) return;
            const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(t);
          });
          return Object.entries(groups).sort().reverse();
        }, [creditCardTransactions]);
        
        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold text-neutral-900">Cart√µes de Cr√©dito</h2>
                <p className="text-sm text-neutral-600">Controle de despesas no cr√©dito</p>
              </div>
            </div>
            
            {groupedByMonth.map(([monthKey, txns]) => {
              const [year, month] = monthKey.split('-');
              const monthName = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][parseInt(month) - 1];
              const total = txns.reduce((sum, t) => sum + t.amount, 0);
              
              return (
                <Card key={monthKey}>
                  <CardHeader>
                    <div className="flex items-center justify-between">
                      <CardTitle>{monthName} {year}</CardTitle>
                      <Badge variant="expense" className="text-lg px-3 py-1">
                        {formatCurrency(total)}
                      </Badge>
                    </div>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      {txns.map(t => (
                        <div 
                          key={t.id} 
                          className={cn(
                            "flex items-center justify-between p-3 rounded-lg",
                            t.type === 'income' ? 'bg-green-50' : 'bg-red-50'
                          )}
                        >
                          <div>
                            <p className="font-medium text-neutral-900 flex items-center gap-2">
                              <span className={cn(
                                "text-lg",
                                t.type === 'income' ? 'text-green-600' : 'text-red-600'
                              )}>
                                {t.type === 'income' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'}
                              </span>
                              {t.description}
                            </p>
                            <p className="text-xs text-neutral-500 ml-7">{formatDateLabel(t.date)}</p>
                          </div>
                          <div className="text-right">
                            <p className={cn(
                              "font-semibold",
                              t.type === 'income' ? 'text-green-600' : 'text-red-600'
                            )}>
                              {t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}
                            </p>
                            {currentUser?.type === 'admin' && (
                              <Badge variant="info" className="text-xs mt-1">{getOwnerName(t.ownerId)}</Badge>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              );
            })}
            
            {groupedByMonth.length === 0 && (
              <Card>
                <CardContent className="py-12 text-center text-neutral-500">
                  Nenhuma transa√ß√£o no cart√£o de cr√©dito encontrada.
                </CardContent>
              </Card>
            )}
          </div>
        );
      };
      
      // ============================================================================
      // IMPORT PAGE
      // ============================================================================
      
      const ImportPage = () => {
        const { transactions, addTransaction } = useAppStore();
        const [parsedTransactions, setParsedTransactions] = useState([]);
        const [selectedFile, setSelectedFile] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [error, setError] = useState(null);
        const [importStats, setImportStats] = useState(null);
        
        const handleFileSelect = async (event) => {
          const file = event.target.files?.[0];
          if (!file) return;
          
          setSelectedFile(file);
          setError(null);
          setIsLoading(true);
          setParsedTransactions([]);
          setImportStats(null);
          
          try {
            const content = await readFileAsText(file);
            const parsed = parseOFX(content);
            
            if (parsed.length === 0) {
              setError('Nenhuma transa√ß√£o encontrada no arquivo. Verifique se √© um arquivo OFX v√°lido.');
            } else {
              setParsedTransactions(parsed);
            }
          } catch (err) {
            console.error('Error reading file:', err);
            setError('Erro ao ler o arquivo. Verifique se √© um arquivo OFX v√°lido.');
          } finally {
            setIsLoading(false);
          }
        };
        
        const handleConfirmImport = () => {
          if (parsedTransactions.length === 0) return;
          
          const userId = 'default-user'; // TODO: Get from auth
          let imported = 0;
          let duplicates = 0;
          
          // Get existing FITID set for duplicate detection
          const existingFitIds = new Set(
            transactions
              .filter(t => t.fitId)
              .map(t => t.fitId)
          );
          
          parsedTransactions.forEach((transaction) => {
            // Check for duplicates using FITID
            if (existingFitIds.has(transaction.fitId)) {
              duplicates++;
              return;
            }
            
            // Add transaction
            addTransaction({
              description: transaction.description,
              amount: transaction.amount,
              type: transaction.type,
              date: transaction.date,
              category: transaction.category,
              paymentMethod: transaction.paymentMethod,
              installments: null,
              userId,
              fitId: transaction.fitId
            });
            
            existingFitIds.add(transaction.fitId);
            imported++;
          });
          
          // Show import stats
          setImportStats({
            total: parsedTransactions.length,
            imported,
            duplicates
          });
          
          // Clear preview
          setParsedTransactions([]);
          setSelectedFile(null);
        };
        
        const handleClearPreview = () => {
          setParsedTransactions([]);
          setSelectedFile(null);
          setError(null);
          setImportStats(null);
        };
        
        return (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Importa√ß√£o de Arquivos OFX</CardTitle>
                <p className="text-sm text-neutral-600">
                  Importe extratos banc√°rios no formato OFX para adicionar transa√ß√µes automaticamente
                </p>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-neutral-700 mb-2">
                    Selecione o arquivo OFX
                  </label>
                  <input
                    type="file"
                    accept=".ofx,.OFX"
                    onChange={handleFileSelect}
                    className="block w-full text-sm text-neutral-900 border border-neutral-300 rounded-lg cursor-pointer bg-white focus:outline-none focus:ring-2 focus:ring-primary-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:text-sm file:font-medium file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"
                  />
                </div>
                
                {isLoading && (
                  <div className="flex items-center gap-2 text-sm text-neutral-600">
                    <div className="animate-spin h-4 w-4 border-2 border-primary-600 border-t-transparent rounded-full" />
                    <span>Processando arquivo...</span>
                  </div>
                )}
                
                {error && (
                  <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p className="text-sm text-red-800">{error}</p>
                  </div>
                )}
                
                {importStats && (
                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <p className="text-sm text-green-800 font-medium mb-2">
                      ‚úÖ Importa√ß√£o conclu√≠da com sucesso!
                    </p>
                    <ul className="text-sm text-green-700 space-y-1">
                      <li>‚Ä¢ Total de transa√ß√µes no arquivo: {importStats.total}</li>
                      <li>‚Ä¢ Transa√ß√µes importadas: {importStats.imported}</li>
                      <li>‚Ä¢ Duplicatas ignoradas: {importStats.duplicates}</li>
                    </ul>
                  </div>
                )}
                
                {selectedFile && !isLoading && (
                  <div className="text-sm text-neutral-600">
                    <p><strong>Arquivo selecionado:</strong> {selectedFile.name}</p>
                    <p><strong>Tamanho:</strong> {(selectedFile.size / 1024).toFixed(2)} KB</p>
                  </div>
                )}
              </CardContent>
            </Card>
            
            {parsedTransactions.length > 0 && (
              <Card>
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <div>
                      <CardTitle>Pr√©via das Transa√ß√µes</CardTitle>
                      <p className="text-sm text-neutral-600">
                        {parsedTransactions.length} transa√ß√µes encontradas
                      </p>
                    </div>
                    <div className="flex gap-2">
                      <Button variant="secondary" onClick={handleClearPreview}>
                        Cancelar
                      </Button>
                      <Button variant="primary" onClick={handleConfirmImport}>
                        Confirmar Importa√ß√£o
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="overflow-x-auto max-h-96 overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="sticky top-0 bg-white">
                        <tr className="text-left text-neutral-500 border-b">
                          <th className="py-2 px-2">Data</th>
                          <th className="py-2 px-2">Descri√ß√£o</th>
                          <th className="py-2 px-2">Tipo</th>
                          <th className="py-2 px-2 text-right">Valor</th>
                          <th className="py-2 px-2">ID</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-neutral-100">
                        {parsedTransactions.map((transaction, index) => (
                          <tr key={index} className="hover:bg-neutral-50">
                            <td className="py-2 px-2 text-neutral-600">
                              {formatDateLabel(transaction.date)}
                            </td>
                            <td className="py-2 px-2 font-medium text-neutral-900">
                              {transaction.description}
                            </td>
                            <td className="py-2 px-2">
                              <Badge variant={transaction.type === 'income' ? 'income' : 'expense'}>
                                {transaction.type === 'income' ? 'Receita' : 'Despesa'}
                              </Badge>
                            </td>
                            <td className={cn(
                              'py-2 px-2 text-right font-semibold',
                              transaction.type === 'income' ? 'text-primary-600' : 'text-red-600'
                            )}>
                              {transaction.type === 'income' ? '+' : '-'}
                              {formatCurrency(transaction.amount)}
                            </td>
                            <td className="py-2 px-2 text-xs text-neutral-500 font-mono">
                              {transaction.fitId.substring(0, 12)}...
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        );
      };
      
      const SettingsPage = () => {
        const { currentUser, syncError, isSyncing } = useFirebaseSync();
        
        return (
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Configura√ß√µes</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div>
                  <h3 className="text-sm font-medium text-neutral-900 mb-2">Sincroniza√ß√£o</h3>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                      <span className="text-sm text-neutral-700">Status de Sincroniza√ß√£o:</span>
                      <Badge variant={isSyncing ? 'warning' : currentUser ? 'success' : 'neutral'}>
                        {isSyncing ? 'Sincronizando...' : currentUser ? 'Conectado' : 'Offline'}
                      </Badge>
                    </div>
                    
                    {currentUser && (
                      <div className="p-3 bg-primary-50 border border-primary-200 rounded-lg">
                        <p className="text-sm text-primary-800">
                          ‚úÖ Seus dados est√£o sendo sincronizados automaticamente com o Firebase
                        </p>
                      </div>
                    )}
                    
                    {!currentUser && (
                      <div className="p-3 bg-amber-50 border border-amber-200 rounded-lg">
                        <p className="text-sm text-amber-800">
                          ‚ö†Ô∏è Fa√ßa login para sincronizar seus dados na nuvem
                        </p>
                      </div>
                    )}
                    
                    {syncError && (
                      <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                        <p className="text-sm text-red-800">{syncError}</p>
                      </div>
                    )}
                  </div>
                </div>
                
                <div>
                  <h3 className="text-sm font-medium text-neutral-900 mb-2">Sobre o Sistema</h3>
                  <p className="text-sm text-neutral-600">
                    Sistema Financeiro Pessoal - Vers√£o 0.1
                  </p>
                  <p className="text-xs text-neutral-500 mt-1">
                    Dados armazenados localmente e sincronizados com Firebase Firestore
                  </p>
                </div>
              </CardContent>
            </Card>
          </div>
        );
      };
      
      // ============================================================================
      // MAIN APP COMPONENT
      // ============================================================================
      
      function App() {
        const { currentUser } = useFirebaseSync();
        
        // Clear any old data storage on first render
        useEffect(() => {
          const oldStorageKey = 'financial-app-storage';
          if (localStorage.getItem(oldStorageKey)) {
            console.log('üßπ Migrating from old storage format...');
            localStorage.removeItem(oldStorageKey);
          }
        }, []);
        
        return (
          <>
            <HashRouter>
              <Layout>
                <Routes>
                  <Route path="/" element={<Dashboard />} />
                  <Route path="/calendar" element={<CalendarPage />} />
                  <Route path="/transactions" element={<TransactionsPage />} />
                  <Route path="/cards" element={<CardsPage />} />
                  <Route path="/import" element={<ImportPage />} />
                  <Route path="/settings" element={<SettingsPage />} />
                  <Route path="*" element={<Dashboard />} />
                </Routes>
              </Layout>
            </HashRouter>
            
            {/* Login Modal - sempre vis√≠vel quando n√£o houver usu√°rio logado */}
            <LoginModal 
              isOpen={!currentUser} 
              onClose={() => {}} 
              canClose={false}
            />
          </>
        );
      }
      
      // ============================================================================
      // RENDER APP
      // ============================================================================
      
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
